<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB; // –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç —Ñ–∞—Å–∞–¥–∞ DB
use App\Models\User;
use App\Models\Deal;
use App\Models\DealFeed;
use App\Services\YandexDiskService;
use App\Models\DealChangeLog;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Storage;
use App\Models\Common;
use Illuminate\Support\Facades\Validator;
use App\Http\Controllers\Traits\NotifyExecutorsTrait;

class DealsController extends Controller
{
    use NotifyExecutorsTrait;
    
    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫
     */
    public function uploadFileToYandex(Request $request)
    {
        try {
            $request->validate([
                'file' => 'required|file|max:2097152', // 2GB –º–∞–∫—Å–∏–º—É–º
                'field_name' => 'required|string',
                'deal_id' => 'sometimes|integer'
            ]);

            $file = $request->file('file');
            $fieldName = $request->input('field_name');
            $dealId = $request->input('deal_id');

            Log::info('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫', [
                'file_name' => $file->getClientOriginalName(),
                'file_size' => $file->getSize(),
                'field_name' => $fieldName,
                'deal_id' => $dealId
            ]);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞
            $yandexService = new YandexDiskService();

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞–ø–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
            $folderPath = 'lk_deals';
            if ($dealId) {
                $folderPath .= '/deal_' . $dealId;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
            $result = $yandexService->uploadFile($file, $folderPath);

            if ($result['success']) {
                Log::info('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫', [
                    'yandex_url' => $result['yandex_url'],
                    'file_name' => $file->getClientOriginalName()
                ]);

                return response()->json([
                    'success' => true,
                    'message' => '–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫',
                    'yandex_url' => $result['yandex_url'],
                    'file_name' => $file->getClientOriginalName(),
                    'field_name' => $fieldName
                ]);
            } else {
                Log::error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫', [
                    'error' => $result['error'] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
                ]);

                return response()->json([
                    'success' => false,
                    'message' => $result['error'] ?? '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫'
                ], 500);
            }

        } catch (\Exception $e) {
            Log::error('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);

            return response()->json([
                'success' => false,
                'message' => '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–¥–µ–ª–∫–∏
     */
    public function fastYandexUpload(Request $request)
    {
        try {
            $request->validate([
                'documents' => 'required|array',
                'documents.*' => 'file|max:2097152', // 2GB –º–∞–∫—Å–∏–º—É–º
                'deal_id' => 'sometimes|integer'
            ]);

            $files = $request->file('documents');
            $dealId = $request->input('deal_id');
            
            Log::info('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –±—ã—Å—Ç—Ä—É—é –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫', [
                'files_count' => count($files),
                'deal_id' => $dealId
            ]);

            $yandexService = new YandexDiskService();
            $uploadResults = [];
            $deal = null;

            // –ï—Å–ª–∏ –µ—Å—Ç—å ID —Å–¥–µ–ª–∫–∏, –ø–æ–ª—É—á–∞–µ–º –µ—ë –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            if ($dealId) {
                $deal = Deal::find($dealId);
                if (!$deal) {
                    return response()->json([
                        'success' => false,
                        'message' => '–°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
                    ], 404);
                }
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞–ø–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
            $folderPath = 'lk_deals';
            if ($dealId) {
                $folderPath .= '/deal_' . $dealId;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã
            foreach ($files as $file) {
                $result = $yandexService->uploadFile($file, $folderPath);
                
                if ($result['success']) {
                    $uploadResults[] = [
                        'success' => true,
                        'url' => $result['url'],
                        'original_name' => $file->getClientOriginalName(),
                        'file_name' => $file->getClientOriginalName()
                    ];

                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–¥–µ–ª–∫–∞, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
                    if ($deal) {
                        $this->updateDealFileFields($deal, $file->getClientOriginalName(), $result['url']);
                    }

                    Log::info('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', [
                        'file_name' => $file->getClientOriginalName(),
                        'url' => $result['url']
                    ]);
                } else {
                    $uploadResults[] = [
                        'success' => false,
                        'error' => $result['message'] ?? '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏',
                        'file_name' => $file->getClientOriginalName()
                    ];

                    Log::error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞', [
                        'file_name' => $file->getClientOriginalName(),
                        'error' => $result['message'] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
                    ]);
                }
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–¥–µ–ª–∫–µ
            if ($deal) {
                $deal->save();
                Log::info('üìù –°–¥–µ–ª–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å –Ω–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏', ['deal_id' => $deal->id]);
            }

            $successCount = count(array_filter($uploadResults, function($result) {
                return $result['success'];
            }));

            return response()->json([
                'success' => $successCount > 0,
                'message' => "–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ {$successCount} –∏–∑ " . count($files) . " —Ñ–∞–π–ª–æ–≤",
                'results' => $uploadResults,
                'deal' => $deal ? $deal->fresh() : null // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å–¥–µ–ª–∫—É
            ]);

        } catch (\Exception $e) {
            Log::error('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);

            return response()->json([
                'success' => false,
                'message' => '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π —Å–¥–µ–ª–∫–∏ —Å —Ñ–∞–π–ª–∞–º–∏
     */
    private function updateDealFileFields($deal, $originalName, $yandexUrl)
    {
        // –ú–∞–ø–∏–Ω–≥ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤ –∫ –ø–æ–ª—è–º —Å–¥–µ–ª–∫–∏
        $extensionToFieldMap = [
            // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã
            'jpg' => ['screenshot_work_1', 'chat_screenshot', 'screenshot_final'],
            'jpeg' => ['screenshot_work_1', 'chat_screenshot', 'screenshot_final'],
            'png' => ['screenshot_work_1', 'chat_screenshot', 'screenshot_final'],
            'gif' => ['screenshot_work_1', 'chat_screenshot', 'screenshot_final'],
            
            // –î–æ–∫—É–º–µ–Ω—Ç—ã –∏ –ø—Ä–æ–µ–∫—Ç—ã
            'pdf' => ['final_project_file', 'work_act', 'execution_order_file'],
            'doc' => ['final_project_file', 'work_act', 'execution_order_file'],
            'docx' => ['final_project_file', 'work_act', 'execution_order_file'],
            
            // –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã
            'dwg' => ['archicad_file'],
            'pln' => ['archicad_file'],
            
            // –ò–∑–º–µ—Ä–µ–Ω–∏—è
            'xlsx' => ['measurements_file'],
            'xls' => ['measurements_file'],
        ];

        $extension = strtolower(pathinfo($originalName, PATHINFO_EXTENSION));
        $fileName = strtolower($originalName);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
        $targetField = null;

        // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        if (strpos($fileName, '–∑–∞–º–µ—Ä') !== false || strpos($fileName, 'measurement') !== false) {
            $targetField = 'measurements_file';
        } elseif (strpos($fileName, '—Ñ–∏–Ω–∞–ª') !== false || strpos($fileName, 'final') !== false) {
            $targetField = 'final_project_file';
        } elseif (strpos($fileName, '–∞–∫—Ç') !== false || strpos($fileName, 'work_act') !== false) {
            $targetField = 'work_act';
        } elseif (strpos($fileName, '—á–∞—Ç') !== false || strpos($fileName, 'chat') !== false) {
            $targetField = 'chat_screenshot';
        } elseif (strpos($fileName, '–∞—Ä—Ö–∏–∫–∞–¥') !== false || strpos($fileName, 'archicad') !== false) {
            $targetField = 'archicad_file';
        } else {
            // –ï—Å–ª–∏ –ø–æ –∏–º–µ–Ω–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
            if (isset($extensionToFieldMap[$extension])) {
                $possibleFields = $extensionToFieldMap[$extension];
                
                // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤–æ–µ –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ
                foreach ($possibleFields as $field) {
                    $yandexField = 'yandex_url_' . $field;
                    if (empty($deal->$yandexField)) {
                        $targetField = $field;
                        break;
                    }
                }
                
                // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ª—è –∑–∞–Ω—è—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤–æ–µ
                if (!$targetField) {
                    $targetField = $possibleFields[0];
                }
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è —Å–¥–µ–ª–∫–∏
        if ($targetField) {
            $yandexUrlField = 'yandex_url_' . $targetField;
            $originalNameField = 'original_name_' . $targetField;
            
            $deal->$yandexUrlField = $yandexUrl;
            $deal->$originalNameField = $originalName;
            
            Log::info('üìé –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª–µ —Å–¥–µ–ª–∫–∏', [
                'field' => $targetField,
                'original_name' => $originalName,
                'yandex_url' => $yandexUrl
            ]);
        } else {
            Log::warning('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª–µ –¥–ª—è —Ñ–∞–π–ª–∞', [
                'file_name' => $originalName,
                'extension' => $extension
            ]);
        }
    }
    
    protected $yandexDiskService;

    public function __construct(YandexDiskService $yandexDiskService)
    {
        $this->yandexDiskService = $yandexDiskService;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        if (!$this->yandexDiskService->checkAuth()) {
            Log::error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ DealsController");
        }

        // –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
        ini_set('upload_max_filesize', '0'); // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
        ini_set('post_max_size', '0'); // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π  
        ini_set('max_execution_time', '0'); // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–∏
        ini_set('max_input_time', '0'); // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–∏ –≤–≤–æ–¥–∞
        ini_set('memory_limit', '2048M'); // 2 –ì–ë –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–¥–µ–ª–æ–∫.
     */
    public function dealCardinator(Request $request)
    {
        $title_site = "–°–¥–µ–ª–∫–∏ | –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≠–∫—Å–ø—Ä–µ—Å—Å-–¥–∏–∑–∞–π–Ω";
        $user = Auth::user();

        $search = $request->input('search');
        $status = $request->input('status');
        $view_type = $request->input('view_type', 'blocks');
        $viewType = $view_type;
          // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        $package = $request->input('package');
        $priceServiceOption = $request->input('price_service_option');
        $dateFrom = $request->input('date_from');
        $dateTo = $request->input('date_to');
        $partnerId = $request->input('partner_id');
        $coordinatorId = $request->input('coordinator_id');
        $sortBy = $request->input('sort_by');

        $query = Deal::query();        // –§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if ($user->status === 'admin') {
            // –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ —Å–¥–µ–ª–∫–∏, –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ñ–∏–ª—å—Ç—Ä –ø–æ coordinator_id –∏ partner_id, –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–¥–∞–Ω—ã
            if ($coordinatorId) {
                $query->where('coordinator_id', $coordinatorId);
            }
            if ($partnerId) {
                $query->where('office_partner_id', $partnerId);
            }
        } elseif ($user->status === 'partner') {
            $query->where('office_partner_id', $user->id);
        } elseif ($user->status === 'coordinator') {
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö —Å–≤–æ–∏—Ö —Å–¥–µ–ª–æ–∫
            // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä—É –Ω–µ –∑–∞–¥–∞–Ω –∏–ª–∏ —Ä–∞–≤–µ–Ω ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (!$coordinatorId || $coordinatorId == $user->id) {
                $query->where('coordinator_id', $user->id);
            } else {
                // –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–¥–µ–ª–∫–∏ –¥—Ä—É–≥–æ–≥–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                $query->where('id', -1); // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            }
        } elseif (in_array($user->status, ['architect', 'designer', 'visualizer'])) {
            $query->whereHas('users', function ($q) use ($user) {
                $q->where('user_id', $user->id)
                  ->where('role', $user->status);
            });
        } else {
            $query->whereHas('users', function ($q) use ($user) {
                $q->where('user_id', $user->id);
            });
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫
        if ($search) {
            $query->where(function($q) use ($search) {
                $q->where('client_phone', 'LIKE', "%{$search}%")
                  ->orWhere('client_email', 'LIKE', "%{$search}%")
                  ->orWhere('project_number', 'LIKE', "%{$search}%")
                  ->orWhere('package', 'LIKE', "%{$search}%")
                  ->orWhere('deal_note', 'LIKE', "%{$search}%")
                  ->orWhere('client_city', 'LIKE', "%{$search}%")
                  ->orWhere('total_sum', 'LIKE', "%{$search}%");
            });
        }

        // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
        if ($request->has('statuses')) {
            $statuses = $request->input('statuses');
            if (!empty($statuses)) {
                $query->whereIn('status', $statuses);
            }
        } elseif ($request->has('status') && !empty($request->status)) {
            $query->where('status', $request->status);
        }        // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (—Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –ª–æ–≥–∏–∫–µ —Ä–æ–ª–µ–π)
        if ($package) $query->where('package', $package);
        if ($priceServiceOption) $query->where('price_service_option', $priceServiceOption);
        if ($dateFrom) $query->whereDate('created_date', '>=', $dateFrom);
        if ($dateTo) $query->whereDate('created_date', '<=', $dateTo);
        // partnerId –∏ coordinatorId –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –ª–æ–≥–∏–∫–µ —Ä–æ–ª–µ–π –≤—ã—à–µ
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
        if ($sortBy) {
            switch ($sortBy) {
                case 'name_asc': $query->orderBy('name', 'asc'); break;
                case 'name_desc': $query->orderBy('name', 'desc'); break;
                case 'created_date_asc': $query->orderBy('created_date', 'desc'); break;
                case 'total_sum_asc': $query->orderBy('total_sum', 'asc'); break;
                case 'total_sum_desc': $query->orderBy('total_sum', 'desc'); break;
                default: $query->orderBy('created_at', 'desc');
            }
        } else {
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            $query->orderBy('created_at', 'desc');
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å—á–µ—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –æ—Ü–µ–Ω–æ–∫
        $query->withCount(['ratings as client_ratings_count' => function($query) {
            $query->whereHas('raterUser', function($q) {
                $q->where('status', 'client');
            });
        }]);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –æ—Ü–µ–Ω–æ–∫
        $query->withAvg(['ratings as client_rating_avg' => function($query) {
            $query->whereHas('raterUser', function($q) {
                $q->where('status', 'client');
            });
        }], 'score');

        $deals = $query->get();

        $statuses = [
            '–ñ–¥–µ–º –¢–ó', '–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞', '–ö–æ–ª–ª–∞–∂–∏', '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è', '–†–∞–±–æ—á–∫–∞/—Å–±–æ—Ä –ò–ü',
            '–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤', '–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω', '–ü—Ä–æ–µ–∫—Ç –Ω–∞ –ø–∞—É–∑–µ', '–í–æ–∑–≤—Ä–∞—Ç',
            '–í —Ä–∞–±–æ—Ç–µ', '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π', '–ù–∞ –ø–æ—Ç–æ–º', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
            '–ë—Ä–∏—Ñ –ø—Ä–∏–∫—Ä–∏–ø–ª–µ–Ω', '–ü–æ–¥–¥–µ—Ä–∂–∫–∞', '–ê–∫—Ç–∏–≤–Ω—ã–π'
        ];

        $feeds = DealFeed::whereIn('deal_id', $deals->pluck('id'))->get();        return view('cardinators', compact(
            'deals',
            'title_site',
            'search',
            'status',
            'viewType',
            'statuses',
            'feeds',
            'package',
            'priceServiceOption',
            'dateFrom',
            'dateTo',
            'partnerId',
            'coordinatorId',
            'sortBy'
        ));
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏
     */
    public function updateDeal(Request $request, $id)
    {
        $deal = Deal::findOrFail($id);
        $user = Auth::user();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        $original = $deal->getAttributes();
        
        // –ü–æ–ª—É—á–∞–µ–º –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - —É–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤
        $validatedData = $request->validate([
            'client_name' => 'required|string|max:255', // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞
            'client_phone' => 'nullable|string|max:20',
            'client_email' => 'nullable|email|max:255',
            'client_city' => 'nullable|string|max:255',
            'client_timezone' => 'nullable|string|max:255', // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
            'status' => 'nullable|string|max:255',
            'coordinator_id' => 'nullable|numeric',
            'office_partner_id' => 'nullable|numeric',
            'architect_id' => 'nullable|numeric',
            'designer_id' => 'nullable|numeric',
            'visualizer_id' => 'nullable|numeric',
            'comment' => 'nullable|string',
            'total_sum' => 'nullable|numeric',
            'package' => 'nullable|string',
            'price_service_option' => 'nullable|string',
            'created_date' => 'nullable|date',
            'start_date' => 'nullable|date',
            'payment_date' => 'nullable|date',
            'project_end_date' => 'nullable|date',
            'visualization_link' => 'nullable|url',
            'project_duration' => 'nullable|integer',
            'client_city_id' => 'nullable|string',
            'completion_responsible' => 'nullable|string',
            'rooms_count_pricing' => 'nullable|string',
            'project_number' => 'nullable|max:150',  // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –Ω–æ–º–µ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
            // –§–∞–π–ª–æ–≤—ã–µ –ø–æ–ª—è - —É–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
            'execution_order_file' => 'nullable|file',
            'measurements_file' => 'nullable|file',
            'final_floorplan' => 'nullable|file',
            'final_collage' => 'nullable|file',
            'final_project_file' => 'nullable|file',
            'work_act' => 'nullable|file',
            'archicad_file' => 'nullable|file',
            'contract_attachment' => 'nullable|file',
            'plan_final' => 'nullable|file',
            'chat_screenshot' => 'nullable|file',
            'avatar_path' => 'nullable|file|image', // –£–±—Ä–∞–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ max:5000
            // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è multiple file uploads - —É–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
            'project_photos' => 'nullable|array',
            'project_photos.*' => 'file', // –£–±—Ä–∞–ª–∏ –≤—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        ]);
        
        // –£–±–∏—Ä–∞–µ–º –ø–æ–ª—è —Ñ–∞–π–ª–æ–≤ –∏–∑ –º–∞—Å—Å–∏–≤–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        $fileFields = [
            'execution_order_file', 'measurements_file', 'final_floorplan', 
            'final_collage', 'final_project_file', 'work_act', 
            'archicad_file', 'contract_attachment', 'plan_final', 'chat_screenshot', 'avatar_path',
            'project_photos'  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à–µ –ø–æ–ª–µ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
        ];
        
        $dataToUpdate = array_diff_key($validatedData, array_flip($fileFields));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –±–µ–∑ —Ñ–∞–π–ª–æ–≤
        $deal->update($dataToUpdate);
        
        // –°–¢–ê–†–ê–Ø —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –û–¢–ö–õ–Æ–ß–ï–ù–ê - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ v3.0 —á–µ—Ä–µ–∑ API
        // –§–∞–π–ª—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ç–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ YandexDiskController API
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø—Ä–æ–µ–∫—Ç–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π)
        $this->handleProjectPhotosUpload($request, $deal);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
        if ($request->hasFile('avatar_path')) {
            $avatarFile = $request->file('avatar_path');
            $avatarPath = $avatarFile->store('deal_avatars', 'public');
            $deal->avatar_path = $avatarPath;
            $deal->save();
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏
        $statusChanged = $original['status'] !== $deal->status;
        $changedToCompleted = $statusChanged && $deal->status === '–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω';
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        $this->logDealChanges($deal, $original, $deal->getAttributes());
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –≤ —Å–¥–µ–ª–∫–µ
        $executorsChanged = 
            ($original['architect_id'] != $deal->architect_id && $deal->architect_id) ||
            ($original['designer_id'] != $deal->designer_id && $deal->designer_id) ||
            ($original['visualizer_id'] != $deal->visualizer_id && $deal->visualizer_id);
            
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã
        if ($executorsChanged) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
            $deal->loadMissing(['architect', 'designer', 'visualizer']);
            $this->notifyExecutorsAboutAttach($deal);
        }
        
        return response()->json([
            'success' => true, 
            'message' => '–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞',
            'status_changed_to_completed' => $changedToCompleted,
            'deal' => $deal,
            'deal_id' => $deal->id // –î–æ–±–∞–≤–ª—è–µ–º ID —Å–¥–µ–ª–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
        ]);
    }
    
    /**
     * –£–°–¢–ê–†–ï–í–®–ò–ô –º–µ—Ç–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫
     * –ó–ê–ú–ï–ù–ï–ù –Ω–∞ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É v3.0 —á–µ—Ä–µ–∑ YandexDiskController API
     * –°–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø
     */
    private function handleYandexDiskFileUploads_DEPRECATED(Request $request, Deal $deal)
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
        if (!$this->yandexDiskService->checkAuth()) {
            Log::error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤", [
                'deal_id' => $deal->id
            ]);
            return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, –µ—Å–ª–∏ –Ω–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        }

        // –ú–∞—Å—Å–∏–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ–ª–µ–π —Ñ–∞–π–ª–æ–≤ –∏ –∏—Ö –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
        $fileFieldsMapping = [
            'execution_order_file' => '–†–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ',
            'measurements_file' => '–ó–∞–º–µ—Ä—ã',
            'final_floorplan' => '–§–∏–Ω–∞–ª—å–Ω–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞',
            'final_collage' => '–§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–ª–ª–∞–∂',
            'final_project_file' => '–§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç',
            'work_act' => '–ê–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç',
            'archicad_file' => '–§–∞–π–ª Archicad',
            'contract_attachment' => '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫ –¥–æ–≥–æ–≤–æ—Ä—É',
            'plan_final' => '–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ —Ñ–∏–Ω–∞–ª', // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ plan_final
            'chat_screenshot' => '–°–∫—Ä–∏–Ω—à–æ—Ç —á–∞—Ç–∞', // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ chat_screenshot
        ];
        
        // –ë–∞–∑–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
        $basePath = config('services.yandex_disk.base_folder', 'lk_deals');
        // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç "deal_IDDEAL" –¥–ª—è –∏–º–µ–Ω–∏ –ø–∞–ø–∫–∏ —Å–¥–µ–ª–∫–∏
        $projectFolder = "deal_{$deal->id}";
        $dealFolder = "{$basePath}/{$projectFolder}";
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
        foreach ($fileFieldsMapping as $fieldName => $filePrefix) {
            if ($request->hasFile($fieldName)) {
                $file = $request->file($fieldName);
                $originalName = $file->getClientOriginalName();
                $fileName = Str::slug($filePrefix) . '_' . time() . '_' . $originalName;
                $diskPath = "{$dealFolder}/{$fieldName}/{$fileName}";

                try {
                    // –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
                    set_time_limit(0);
                    ini_set('memory_limit', '-1');
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫
                    $this->yandexDiskService->setTimeout(0); // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

                    $uploadResult = $this->yandexDiskService->uploadFile($file, $diskPath);

                    if ($uploadResult['success']) {
                        $deal->update([
                            "yandex_url_{$fieldName}" => $uploadResult['url'],
                            "yandex_disk_path_{$fieldName}" => $uploadResult['path'],
                            "original_name_{$fieldName}" => $originalName,
                        ]);

                        Log::info("–§–∞–π–ª {$fieldName} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫", [
                            'deal_id' => $deal->id,
                            'path' => $diskPath
                        ]);
                    } else {
                        Log::error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ {$fieldName} –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫", [
                            'deal_id' => $deal->id,
                            'error' => $uploadResult['message'] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
                        ]);
                    }
                } catch (\Exception $e) {
                    Log::error("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ {$fieldName} –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫", [
                        'deal_id' => $deal->id, 
                        'error' => $e->getMessage()
                    ]);
                }
            }
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫
     */
    private function handleProjectPhotosUpload(Request $request, Deal $deal)
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ã–ª–∏ –ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ñ–∞–π–ª—ã –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        if (!$request->hasFile('project_photos') || !$this->yandexDiskService->checkAuth()) {
            if (!$request->hasFile('project_photos')) {
                Log::info("–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ project_photos –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏", ['deal_id' => $deal->id]);
            } else {
                Log::error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π", [
                    'deal_id' => $deal->id
                ]);
            }
            return;
        }
        
        $files = $request->file('project_photos');
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π $files
        if (!is_array($files)) {
            Log::error("project_photos –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º", [
                'deal_id' => $deal->id,
                'type' => gettype($files)
            ]);
            return;
        }
        
        // –ë–∞–∑–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
        $basePath = config('services.yandex_disk.base_folder', 'lk_deals');
        // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç "deal_IDDEAL" –¥–ª—è –∏–º–µ–Ω–∏ –ø–∞–ø–∫–∏ —Å–¥–µ–ª–∫–∏
        $projectFolder = "deal_{$deal->id}";
        $photosFolder = "{$basePath}/{$projectFolder}/project_photos";
        
        try {
            // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–µ, –µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            $dirCreated = $this->yandexDiskService->createDirectory($photosFolder);
            
            if (!$dirCreated) {
                Log::error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–µ", [
                    'deal_id' => $deal->id,
                    'folder' => $photosFolder
                ]);
                return;
            }
            
            Log::info("–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ", [
                'deal_id' => $deal->id,
                'folder' => $photosFolder
            ]);
            
            // –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
            set_time_limit(0);
            ini_set('memory_limit', '-1');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫
            $this->yandexDiskService->setTimeout(0); // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
            
            $uploadedCount = 0;
            $maxFiles = 100; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –¥–æ 100
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–æ maxFiles
            $filesToUpload = array_slice($files, 0, $maxFiles);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
            foreach ($filesToUpload as $index => $file) {
                if (!$file->isValid()) {
                    Log::error("–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ñ–∞–π–ª project_photos[{$index}]", [
                        'deal_id' => $deal->id,
                        'error' => $file->getError()
                    ]);
                    continue;
                }
                
                $originalName = $file->getClientOriginalName();
                $safeFileName = preg_replace('/[^a-zA-Z0-9_.-]/', '_', $originalName);
                $fileName = 'photo_' . time() . '_' . $index . '_' . $safeFileName;
                $diskPath = "{$photosFolder}/{$fileName}";
                
                Log::info("–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫", [
                    'deal_id' => $deal->id,
                    'file' => $originalName,
                    'path' => $diskPath
                ]);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫
                $uploadResult = $this->yandexDiskService->uploadFile($file, $diskPath);
                
                if ($uploadResult['success']) {
                    $uploadedCount++;
                    Log::info("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫", [
                        'deal_id' => $deal->id,
                        'file' => $originalName,
                        'path' => $diskPath
                    ]);
                } else {
                    Log::error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫", [
                        'deal_id' => $deal->id,
                        'file' => $originalName,
                        'error' => $uploadResult['message'] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
                    ]);
                }
            }
            
            // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ñ–∞–π–ª—ã, –ø—É–±–ª–∏–∫—É–µ–º –ø–∞–ø–∫—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏
            if ($uploadedCount > 0) {
                $folderPublicUrl = $this->yandexDiskService->publishFile($photosFolder);
                
                if ($folderPublicUrl) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ
                    $deal->update([
                        'photos_folder_url' => $folderPublicUrl,
                        'photos_count' => $uploadedCount,
                        'yandex_disk_photos_path' => $photosFolder,
                    ]);
                    
                    Log::info("–ü–∞–ø–∫–∞ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –ø—Ä–æ–µ–∫—Ç–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞", [
                        'deal_id' => $deal->id,
                        'url' => $folderPublicUrl,
                        'count' => $uploadedCount
                    ]);
                } else {
                    Log::error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–∞–ø–∫—É —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏", [
                        'deal_id' => $deal->id,
                        'folder' => $photosFolder
                    ]);
                }
            }
        } catch (\Exception $e) {
            Log::error("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫", [
                'deal_id' => $deal->id,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
        }
    }

    protected function logDealChanges($deal, $original, $new)
    {
        foreach (['updated_at', 'created_at'] as $key) {
            unset($original[$key], $new[$key]);
        }

        $changes = [];
        foreach ($new as $key => $newValue) {
            if (array_key_exists($key, $original) && $original[$key] != $newValue) {
                $changes[$key] = [
                    'old' => $original[$key],
                    'new' => $newValue,
                ];
            }
        }

        if (!empty($changes)) {
            DealChangeLog::create([
                'deal_id'   => $deal->id,
                'user_id'   => Auth::id(),
                'user_name' => Auth::user()->name,
                'changes'   => $changes,
            ]);
        }
    }

    public function storeDealFeed(Request $request, $dealId)
    {
        $request->validate([
            'content' => 'required|string|max:1990',
        ]);

        $deal = Deal::findOrFail($dealId);
        $user = Auth::user();

        $feed = new DealFeed();
        $feed->deal_id = $deal->id;
        $feed->user_id = $user->id;
        $feed->content = $request->input('content');
        $feed->save();

        return response()->json([
            'user_name'  => $user->name,
            'content'    => $feed->content,
            'date'       => $feed->created_at->format('d.m.Y H:i'),
            'avatar_url' => $user->avatar_url,
        ]);
    }

    /**
     * –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ ‚Äì –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞.
     */
    public function createDeal()
    {
        $user = Auth::user();
        if (!in_array($user->status, ['coordinator', 'admin', 'partner'])) {
            return redirect()->route('deal.cardinator')
                ->with('error', '–¢–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–¥–µ–ª–∫—É.');
        }
        $title_site = "–°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏";

        $citiesFile = public_path('cities.json');
        if (file_exists($citiesFile)) {
            $citiesJson = file_get_contents($citiesFile);
            $russianCities = json_decode($citiesJson, true);
        } else {
            $russianCities = [];
        }

        $coordinators = User::where('status', 'coordinator')->get();
        $partners = User::where('status', 'partner')->get();

        return view('create_deal', compact(
            'title_site',
            'user',
            'coordinators',
            'partners',
            'russianCities'
        ));
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞ –¥–ª—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö.
     */
    public function storeDeal(Request $request)
    {
        $validated = $request->validate([
            'client_phone'            => 'required|string|max:50',
            'client_name'             => 'required|string|max:255', // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞
            'package'                 => 'required|string|max:255',
            'price_service_option'    => 'required|string|max:255',
            'rooms_count_pricing'     => 'nullable|string|max:255',
            'execution_order_comment' => 'nullable|string|max:1000',
            'execution_order_file'    => 'nullable|file|mimes:pdf,jpg,jpeg,png', // –£–±—Ä–∞–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ max:5120
            'office_partner_id'       => 'nullable|exists:users,id',
            'coordinator_id'          => 'nullable|exists:users,id',
            'total_sum'               => 'nullable|numeric',
            'client_info'             => 'nullable|string',
            'payment_date'            => 'nullable|date',
            'execution_comment'       => 'nullable|string',
            'comment'                 => 'nullable|string',
            'client_timezone'         => 'nullable|string',
            'completion_responsible'  => 'required|string', // –ò–∑–º–µ–Ω–µ–Ω–æ —Å nullable –Ω–∞ required
            'start_date'              => 'nullable|date',
            'project_duration'        => 'nullable|integer',
            'project_end_date'        => 'nullable|date',
            'documents'               => 'nullable|array', // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –º–∞—Å—Å–∏–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            'documents.*'             => 'nullable|file', // –£–±—Ä–∞–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ max:20480
        ]);

        $user = Auth::user(); 
        if (!in_array($user->status, ['coordinator', 'admin', 'partner'])) {
            return redirect()->route('deal.cardinator')
                ->with('error', '–¢–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–¥–µ–ª–∫—É.');
        } 
 
        try {
            $coordinatorId = $validated['coordinator_id'] ?? auth()->id();

            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ (—É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤)
            $normalizedPhone = preg_replace('/\D/', '', $validated['client_phone']);

            // –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            $existingUser = User::where('phone', 'LIKE', '%' . $normalizedPhone . '%')->first();
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Ç–µ–∫—É—â–µ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ user_id –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ—Ç NULL
            $userId = $existingUser ? $existingUser->id : auth()->id();

            $deal = Deal::create([
                'client_phone'           => $validated['client_phone'],
                'status'                 => '–ñ–¥–µ–º –¢–ó', // —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                'package'                => $validated['package'],
                'client_name'            => $validated['client_name'], // –ò—Å–ø–æ–ª—å–∑—É–µ–º client_name –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
                'price_service_option'   => $validated['price_service_option'],
                'rooms_count_pricing'    => $validated['rooms_count_pricing'] ?? null,
                'execution_order_comment'=> $validated['execution_order_comment'] ?? null,
                'office_partner_id'      => $validated['office_partner_id'] ?? null,
                'coordinator_id'         => $coordinatorId,
                'total_sum'              => $validated['total_sum'] ?? null,
                'client_info'            => $validated['client_info'] ?? null,
                'payment_date'           => $validated['payment_date'] ?? null,
                'execution_comment'      => $validated['execution_comment'] ?? null,
                'comment'                => $validated['comment'] ?? null,
                'client_timezone'        => $validated['client_timezone'] ?? null,
                'completion_responsible' => $validated['completion_responsible'] ?? null,
                'user_id'                => $userId, // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Ç–µ–∫—É—â–µ–≥–æ
                'registration_token'     => Str::random(32),
                'registration_token_expiry' => now()->addDays(7),
                'start_date'             => $validated['start_date'] ?? null,
                'project_duration'       => $validated['project_duration'] ?? null,
                'project_end_date'       => $validated['project_end_date'] ?? null,
            ]);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –ø–æ–ª—É—á–∞–µ–º –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º
            if ($request->hasFile('documents')) {
                $documentsPaths = $this->saveDocuments($request, $deal->id);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç–∏ –≤ JSON-–ø–æ–ª–µ documents
                if (!empty($documentsPaths)) {
                    $deal->documents = json_encode($documentsPaths);
                    $deal->save();
                    
                    // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
                    Log::info('–î–æ–∫—É–º–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è —Å–¥–µ–ª–∫–∏ ID: ' . $deal->id, [
                        'count' => count($documentsPaths),
                        'paths' => $documentsPaths
                    ]);
                }
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
            $fileFields = [
                'avatar',
                'execution_order_file',
            ];

            foreach ($fileFields as $field) {
                $uploadData = $this->handleFileUpload($request, $deal, $field, $field === 'avatar' ? 'avatar_path' : $field);
                if (!empty($uploadData)) {
                    $deal->update($uploadData);
                }
            }

            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞
            $deal->users()->attach([auth()->id() => ['role' => 'coordinator']]);

            // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ —Å–≤—è–∑–µ–π –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã deal_user
            $dealUsers = [auth()->id() => ['role' => 'coordinator']];
            if ($request->filled('architect_id') && User::where('id', $request->input('architect_id'))->exists()) {
                $dealUsers[$request->input('architect_id')] = ['role' => 'architect'];
                $deal->architect_id = $request->input('architect_id');
            }
            if ($request->filled('designer_id') && User::where('id', $request->input('designer_id'))->exists()) {
                $dealUsers[$request->input('designer_id')] = ['role' => 'designer'];
                $deal->designer_id = $request->input('designer_id');
            }
            if ($request->filled('visualizer_id') && User::where('id', $request->input('visualizer_id'))->exists()) {
                $dealUsers[$request->input('visualizer_id')] = ['role' => 'visualizer'];
                $deal->visualizer_id = $request->input('visualizer_id');
            }

            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω
            if ($existingUser) {
                $dealUsers[$existingUser->id] = ['role' => 'client'];
                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –ª–æ–≥ –ø—Ä–∏–≤—è–∑–∫—É –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                \Illuminate\Support\Facades\Log::info('–ö–ª–∏–µ–Ω—Ç –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–¥–µ–ª–∫–µ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞', [
                    'deal_id' => $deal->id,
                    'client_id' => $existingUser->id,
                    'client_phone' => $validated['client_phone'],
                    'normalized_phone' => $normalizedPhone
                ]);
            }

            $deal->save();
            $deal->users()->attach($dealUsers);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–º—Å —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–æ–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –µ—â—ë –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
            if (!$existingUser) {
                $this->sendSmsNotification($deal, $deal->registration_token);
            } else {
                // –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏
                $deal->status = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
                $deal->save();
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–¥–µ–ª–∫–∏, –µ—Å–ª–∏ —Ç–∞–∫–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç –ø–æ email
            if(!empty($deal->client_email)) {
                $clientByEmail = User::where('email', $deal->client_email)->first();
                if($clientByEmail && !$deal->users()->where('user_id', $clientByEmail->id)->exists()) {
                    $deal->users()->attach($clientByEmail->id, ['role' => 'client']);
                }
            }

            return redirect()->route('deal.cardinator')->with('success', '–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞.');
        } catch (\Exception $e) {
            Log::error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏: " . $e->getMessage());
            return redirect()->back()->with('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏: ' . $e->getMessage());
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –ø—É—Ç–µ–π
     * 
     * @param Request $request
     * @param int $dealId ID —Å–¥–µ–ª–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏
     * @return array –ú–∞—Å—Å–∏–≤ –ø—É—Ç–µ–π –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
     */
    private function saveDocuments(Request $request, $dealId)
    {
        $documentsPaths = [];
        
        if ($request->hasFile('documents')) {
            // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            $directory = "dels/{$dealId}";
            $fullPath = storage_path("app/public/{$directory}");
            
            if (!file_exists($fullPath)) {
                mkdir($fullPath, 0755, true);
            }
            
            foreach ($request->file('documents') as $file) {
                if ($file->isValid()) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞, –Ω–æ –¥–µ–ª–∞–µ–º –µ–≥–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º
                    $fileName = pathinfo($file->getClientOriginalName(), PATHINFO_FILENAME);
                    $safeFileName = preg_replace('/[^a-zA-Z0-9_.-]/', '_', $fileName);
                    $extension = $file->getClientOriginalExtension();
                    $uniqueFileName = $safeFileName . '_' . time() . '_' . uniqid() . '.' . $extension;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –≤ storage/app/public/dels/{dealId}
                    $path = $file->storeAs($directory, $uniqueFileName, 'public');
                    
                    if ($path) {
                        $documentsPaths[] = $path;
                    }
                }
            }
        }
        
        return $documentsPaths;
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SMS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä—É –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–¥–µ–ª–∫–∏
     *
     * @param \App\Models\Deal $deal –°–¥–µ–ª–∫–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
     * @param string $oldStatus –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏
     * @return void
     */
    protected function notifyCoordinatorAboutStatusChange($deal, $oldStatus)
    {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞
            if (!$deal->coordinator_id) {
                Log::warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å SMS: —É —Å–¥–µ–ª–∫–∏ #{$deal->id} –Ω–µ —É–∫–∞–∑–∞–Ω –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä");
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞
            $coordinator = \App\Models\User::find($deal->coordinator_id);
            if (!$coordinator || !$coordinator->phone) {
                Log::warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å SMS: —É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞ —Å–¥–µ–ª–∫–∏ #{$deal->id} –Ω–µ—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
                return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            $message = "–°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ #{$deal->id} –∏–∑–º–µ–Ω–µ–Ω c \"{$oldStatus}\" –Ω–∞ \"{$deal->status}\". –ö–ª–∏–µ–Ω—Ç: {$deal->name}";
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏—è
            if (strlen($message) > 160) {
                $message = substr($message, 0, 157) . '...';
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º SMS —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
            $smsService = new \App\Services\SmsService();
            $result = $smsService->sendSms($coordinator->phone, $message);
            
            if (!$result) {
                Log::error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ SMS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä—É {$coordinator->name} ({$coordinator->phone})");
            }
        } catch (\Exception $e) {
            Log::error("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ SMS –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞: " . $e->getMessage());
        }
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SMS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–¥–µ–ª–∫–∏
     *
     * @param \App\Models\Deal $deal –°–¥–µ–ª–∫–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
     * @param string $oldStatus –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏
     * @return void
     */
    protected function notifyClientAboutStatusChange($deal, $oldStatus)
    {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
            if (!$deal->client_phone) {
                Log::warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å SMS –∫–ª–∏–µ–Ω—Ç—É: —É —Å–¥–µ–ª–∫–∏ #{$deal->id} –Ω–µ —É–∫–∞–∑–∞–Ω —Ç–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞");
                return;
            }
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            $rawPhone = preg_replace('/\D/', '', $deal->client_phone);
            if (strlen($rawPhone) < 10) {
                Log::warning("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å SMS: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Å–¥–µ–ª–∫–µ #{$deal->id}");
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–æ–º–µ–Ω —Å–∞–π—Ç–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            $domain = config('app.url', 'https://express-design.ru');
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            $message = "–°—Ç–∞—Ç—É—Å –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω —Å \"{$oldStatus}\" –Ω–∞ \"{$deal->status}\". –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: {$domain}";
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏—è
            if (strlen($message) > 160) {
                $message = substr($message, 0, 157) . '...';
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º SMS —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
            $apiKey = config('services.smsru.api_id', '6CDCE0B0-6091-278C-5145-360657FF0F9B');
            $response = Http::get("https://sms.ru/sms/send", [
                'api_id'    => $apiKey,
                'to'        => $rawPhone,
                'msg'       => $message,
                'partner_id'=> 1,
            ]);
            
            if ($response->failed()) {
                Log::error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ SMS –∫–ª–∏–µ–Ω—Ç—É –¥–ª—è —Å–¥–µ–ª–∫–∏ #{$deal->id}. –û—Ç–≤–µ—Ç: " . $response->body());
            } else {
                Log::info("SMS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç—É", [
                    'deal_id' => $deal->id,
                    'phone' => $rawPhone,
                    'new_status' => $deal->status,
                    'old_status' => $oldStatus
                ]);
            }
        } catch (\Exception $e) {
            Log::error("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ SMS –∫–ª–∏–µ–Ω—Ç—É –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞: " . $e->getMessage());
        }
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ SMS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–æ–π.
     */
    private function sendSmsNotification($deal, $registrationToken)
    {
        if (!$registrationToken) {
            Log::error("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è —Å–¥–µ–ª–∫–∏ ID: {$deal->id}");
            throw new \Exception('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è —Å–¥–µ–ª–∫–∏.');
        }

        $rawPhone = preg_replace('/\D/', '', $deal->client_phone);

        $apiKey = config('services.smsru.api_id', '6CDCE0B0-6091-278C-5145-360657FF0F9B');

        $response = Http::get("https://sms.ru/sms/send", [
            'api_id'    => $apiKey,
            'to'        => $rawPhone,
            'msg'       => "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ: https://lk.express-diz.ru/register ",
            'partner_id'=> 1,
        ]);

        if ($response->failed()) {
            Log::error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ SMS –¥–ª—è —Å–¥–µ–ª–∫–∏ ID: {$deal->id}. –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " . $response->body());
            throw new \Exception('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ SMS.');
        }
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–¥–µ–ª–∫–∏.
     */
    public function changeLogsForDeal($dealId)
    {
        $deal = Deal::findOrFail($dealId);
        $logs = DealChangeLog::where('deal_id', $deal->id)
            ->orderBy('created_at', 'desc')
            ->get();
        $title_site = "–õ–æ–≥–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–¥–µ–ª–∫–∏";
        return view('deal_change_logs', compact('deal', 'logs', 'title_site'));
    }

    /**
     * –ú–µ—Ç–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ª–µ–Ω—Ç—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ —Å–¥–µ–ª–∫–µ.
     * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è AJAX‚Äë–∑–∞–ø—Ä–æ—Å–æ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å –∑–∞–ø–∏—Å—è–º–∏ –ª–µ–Ω—Ç—ã.
     */
    public function getDealFeeds($dealId)
    {
        try {
            $deal = Deal::findOrFail($dealId);
            $feeds = $deal->dealFeeds()->with('user')->orderBy('created_at', 'desc')->get();
            $result = $feeds->map(function ($feed) {
                return [
                    'user_name'  => $feed->user->name,
                    'content'    => $feed->content,
                    'date'       => $feed->created_at->format('d.m.Y H:i'),
                    'avatar_url' => $feed->user->avatar_url ? $feed->user->avatar_url : asset('storage/default-avatar.png'),
                ];
            });
            return response()->json($result);
        } catch (\Exception $e) {
            Log::error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–µ–Ω—Ç—ã: " . $e->getMessage());
            return response()->json(['error' => '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–µ–Ω—Ç—ã'], 500);
        }
    }
    
    /**
     * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—â–∏—Ö –ª–æ–≥–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫.
     */
    public function changeLogs()
    {
        $logs = DealChangeLog::with('deal')
            ->orderBy('created_at', 'desc')
            ->paginate(50);
        $title_site = "–õ–æ–≥–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–¥–µ–ª–æ–∫";
        return view('deals.deal_change_logs', compact('logs', 'title_site'));
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç —Å–¥–µ–ª–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –±—Ä–∏—Ñ–∞
     *
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function createDealFromBrief(Request $request)
    {
        try {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ –±—Ä–∏—Ñ–∞
            $validator = Validator::make($request->all(), [
                'brief_id' => 'required|integer',
                'brief_type' => 'required|in:common,commercial',
                'client_id' => 'required|exists:users,id',
            ]);
            
            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ' . implode(', ', $validator->errors()->all())
                ], 422);
            }
            
            $briefId = $request->input('brief_id');
            $briefType = $request->input('brief_type');
            $clientId = $request->input('client_id');
            
            // –ü–æ–ª—É—á–∞–µ–º –±—Ä–∏—Ñ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if ($briefType === 'common') {
                $brief = Common::findOrFail($briefId);
                $briefTitle = $brief->title ?? '–°–¥–µ–ª–∫–∞ –ø–æ –æ–±—â–µ–º—É –±—Ä–∏—Ñ—É #' . $briefId;
            } else {
                $brief = \App\Models\Commercial::findOrFail($briefId);
                $briefTitle = $brief->title ?? '–°–¥–µ–ª–∫–∞ –ø–æ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–º—É –±—Ä–∏—Ñ—É #' . $briefId;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–¥–µ–ª–∫–∞ –ø–æ —ç—Ç–æ–º—É –±—Ä–∏—Ñ—É –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞
            if ($brief->deal_id) {
                return response()->json([
                    'success' => false,
                    'message' => '–°–¥–µ–ª–∫–∞ –ø–æ –¥–∞–Ω–Ω–æ–º—É –±—Ä–∏—Ñ—É —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞'
                ], 400);
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞
            $client = User::findOrFail($clientId);
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É
            
            $deal = new Deal();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤—è–∑—å —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º —Ç–∏–ø–æ–º –±—Ä–∏—Ñ–∞
            if ($briefType === 'common') {
                $deal->common_id = $briefId;
            } else {
                $deal->commercial_id = $briefId;
            }
            
            $deal->user_id = $clientId;
            $deal->client_name = $client->name;
            $deal->client_phone = $client->phone;
            $deal->client_email = $client->email;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±—Ä–∏—Ñ–∞
            $deal->name = $briefTitle;
            $deal->status = '–í —Ä–∞–±–æ—Ç–µ';
            $deal->coordinator_id = Auth::id(); // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–º
            
            // –î—Ä—É–≥–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
            // ...
            
            $deal->save();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±—Ä–∏—Ñ, —É–∫–∞–∑—ã–≤–∞—è —Å—Å—ã–ª–∫—É –Ω–∞ —Å–æ–∑–¥–∞–Ω–Ω—É—é —Å–¥–µ–ª–∫—É
            $brief->deal_id = $deal->id;
            $brief->save();
            
            Log::info('–°–æ–∑–¥–∞–Ω–∞ –í —Ä–∞–±–æ—Ç–µ –∏–∑ –±—Ä–∏—Ñ–∞', [
                'deal_id' => $deal->id,
                'brief_id' => $briefId,
                'brief_type' => $briefType,
                'user_id' => $clientId, 
                'creator_id' => Auth::id()
            ]);
            
            return response()->json([
                'success' => true,
                'message' => '–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞',
                'deal_id' => $deal->id,
                'redirect_url' => route('deal.cardinator') // –º–µ–Ω—è–µ–º –º–∞—Ä—à—Ä—É—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
            ]);
            
        } catch (\Exception $e) {
            Log::error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏ –∏–∑ –±—Ä–∏—Ñ–∞: ' . $e->getMessage(), [
                'exception' => $e,
                'request' => $request->all()
            ]);
            
            return response()->json([
                'success' => false,
                'message' => '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å–≤—è–∑–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)
     *
     * @param int $dealId
     * @return \Illuminate\Http\RedirectResponse
     */
    public function deleteDeal($dealId)
    {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ middleware, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É)
        if (Auth::user()->status !== 'admin') {
            return redirect()->back()->with('error', '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫');
        }
        
        try {
            $deal = Deal::findOrFail($dealId);
            
            // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
            Log::info('–£–¥–∞–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º', [
                'deal_id' => $deal->id,
                'deal_name' => $deal->name,
                'admin_id' => Auth::id(),
                'admin_name' => Auth::user()->name
            ]);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –±—Ä–∏—Ñ–∞ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π
            $briefId = $deal->brief_id;
            $briefType = $deal->brief_type;
            
            // –£–¥–∞–ª—è–µ–º —Å–¥–µ–ª–∫—É
            $deal->delete();
            
            return redirect()->route('deal.cardinator')->with('success', '–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞. –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
            
        } catch (\Exception $e) {
            Log::error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏: ' . $e->getMessage(), [
                'exception' => $e,
                'deal_id' => $dealId,
                'admin_id' => Auth::id()
            ]);
            
            return redirect()->back()->with('error', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏: ' . $e->getMessage());
        }
    }

    /**
     * –ü–æ–∏—Å–∫ –±—Ä–∏—Ñ–æ–≤ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
     *
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function findBriefsByDealPhone(Request $request)
    {
        try {
            $dealId = $request->input('deal_id');
            $clientPhone = $request->input('client_phone');
            
            if (empty($clientPhone)) {
                return response()->json([
                    'success' => false,
                    'message' => '–ù–µ —É–∫–∞–∑–∞–Ω —Ç–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞'
                ], 400);
            }
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ (—É–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã)
            $normalizedPhone = preg_replace('/[^0-9]/', '', $clientPhone);
            
            // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            \Log::info('–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –±—Ä–∏—Ñ–æ–≤', [
                'dealId' => $dealId,
                'original_phone' => $clientPhone,
                'normalized_phone' => $normalizedPhone
            ]);
            
            // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            $query = \App\Models\User::where(function($q) use ($normalizedPhone) {
                // –ò—â–µ–º –ø–æ –ø–æ–ª–Ω–æ–º—É –Ω–æ–º–µ—Ä—É
                $q->where('phone', 'LIKE', '%' . $normalizedPhone . '%');
                
                // –î–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤ –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
                if (strlen($normalizedPhone) >= 10) {
                    // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ü–∏—Ñ—Ä (–±–µ–∑ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã)
                    $lastTenDigits = substr($normalizedPhone, -10);
                    $q->orWhere('phone', 'LIKE', '%' . $lastTenDigits . '%');
                    
                    // –í–∞—Ä–∏–∞—Ü–∏–∏ —Å 7 –∏ 8 –≤ –Ω–∞—á–∞–ª–µ –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤
                    if (strlen($normalizedPhone) == 11) {
                        if (substr($normalizedPhone, 0, 1) == '7') {
                            $altPhone = '8' . substr($normalizedPhone, 1);
                            $q->orWhere('phone', 'LIKE', '%' . $altPhone . '%');
                        } else if (substr($normalizedPhone, 0, 1) == '8') {
                            $altPhone = '7' . substr($normalizedPhone, 1);
                            $q->orWhere('phone', 'LIKE', '%' . $altPhone . '%');
                        }
                    }
                }
                
                // –ò—â–µ–º –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º —Ü–∏—Ñ—Ä–∞–º –Ω–æ–º–µ—Ä–∞ –¥–ª—è –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
                if (strlen($normalizedPhone) >= 6) {
                    $lastDigits = substr($normalizedPhone, -6);
                    $q->orWhere('phone', 'LIKE', '%' . $lastDigits);
                }
            });
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            $users = $query->get();
            $userIds = $users->pluck('id')->toArray();
            
            \Log::info('–ù–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É', [
                'count' => count($users),
                'user_ids' => $userIds
            ]);
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–¥–µ–ª–∫–µ
            $deal = \App\Models\Deal::find($dealId);
            
            if (!$deal) {
                return response()->json([
                    'success' => false,
                    'message' => '–°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
                ], 404);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –±—Ä–∏—Ñ–æ–≤
            $hasAttachedBrief = !empty($deal->common_id) || !empty($deal->commercial_id);
            $attachedBriefType = !empty($deal->common_id) ? 'common' : (!empty($deal->commercial_id) ? 'commercial' : null);
            
            // –ü–æ–ª—É—á–∞–µ–º –±—Ä–∏—Ñ—ã –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            $commonBriefs = [];
            $commercialBriefs = [];
            
            if (!empty($userIds)) {
                // –û–±—â–∏–µ –±—Ä–∏—Ñ—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π" –∏–ª–∏ "–ó–∞–≤–µ—Ä—à–µ–Ω"
                $commonBriefs = \App\Models\Common::whereIn('user_id', $userIds)
                    ->whereIn('status', ['–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π', '–ó–∞–≤–µ—Ä—à–µ–Ω'])
                    ->where(function($query) use ($dealId) {
                        $query->whereNull('deal_id')  // –¢–æ–ª—å–∫–æ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –±—Ä–∏—Ñ—ã
                              ->orWhere('deal_id', $dealId); // –ò–ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —Ç–µ–∫—É—â–µ–π —Å–¥–µ–ª–∫–µ
                    })
                    ->get()
                    ->map(function($brief) use ($dealId, $users) {
                        $userName = '';
                        foreach ($users as $user) {
                            if ($user->id == $brief->user_id) {
                                $userName = $user->name;
                                break;
                            }
                        }
                        
                        return [
                            'id' => $brief->id,
                            'title' => $brief->title ?? ('–ë—Ä–∏—Ñ #' . $brief->id),
                            'user_id' => $brief->user_id,
                            'user_name' => $userName,
                            'created_at' => $brief->created_at->format('d.m.Y H:i'),
                            'already_linked' => $brief->deal_id == $dealId
                        ];
                    })
                    ->toArray();
                
                // –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –±—Ä–∏—Ñ—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π" –∏–ª–∏ "–ó–∞–≤–µ—Ä—à–µ–Ω"
                $commercialBriefs = \App\Models\Commercial::whereIn('user_id', $userIds)
                    ->whereIn('status', ['–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π', '–ó–∞–≤–µ—Ä—à–µ–Ω'])
                    ->where(function($query) use ($dealId) {
                        $query->whereNull('deal_id')  // –¢–æ–ª—å–∫–æ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –±—Ä–∏—Ñ—ã
                              ->orWhere('deal_id', $dealId); // –ò–ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —Ç–µ–∫—É—â–µ–π —Å–¥–µ–ª–∫–µ
                    })
                    ->get()
                    ->map(function($brief) use ($dealId, $users) {
                        $userName = '';
                        foreach ($users as $user) {
                            if ($user->id == $brief->user_id) {
                                $userName = $user->name;
                                break;
                            }
                        }
                        
                        return [
                            'id' => $brief->id,
                            'title' => $brief->title ?? ('–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –±—Ä–∏—Ñ #' . $brief->id),
                            'user_id' => $brief->user_id,
                            'user_name' => $userName,
                            'created_at' => $brief->created_at->format('d.m.Y H:i'),
                            'already_linked' => $brief->deal_id == $dealId
                        ];
                    })
                    ->toArray();
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
            $usersInfo = $users->map(function($user) {
                return [
                    'id' => $user->id,
                    'name' => $user->name,
                    'email' => $user->email,
                    'phone' => $user->phone
                ];
            })->toArray();
            
            return response()->json([
                'success' => true,
                'users' => $usersInfo,
                'briefs' => $commonBriefs,
                'commercials' => $commercialBriefs,
                'has_attached_brief' => $hasAttachedBrief,
                'attached_brief_type' => $attachedBriefType,
                'searched_phone' => $clientPhone,
                'message' => count($commonBriefs) + count($commercialBriefs) > 0 
                    ? '–ù–∞–π–¥–µ–Ω—ã –±—Ä–∏—Ñ—ã –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞' 
                    : '–ë—Ä–∏—Ñ—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞'
            ]);
        } catch (\Exception $e) {
            \Log::error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –±—Ä–∏—Ñ–æ–≤ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: ' . $e->getMessage(), [
                'exception' => $e,
                'trace' => $e->getTraceAsString()
            ]);
            
            return response()->json([
                'success' => false,
                'message' => '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –±—Ä–∏—Ñ–æ–≤: ' . $e->getMessage()
            ], 500);
        }
    }
    
    /**
     * –ü—Ä–∏–≤—è–∑–∫–∞ –±—Ä–∏—Ñ–∞ –∫ —Å–¥–µ–ª–∫–µ
     *
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function linkBriefToDeal(Request $request)
    {
        try {
            $dealId = $request->input('deal_id');
            $briefId = $request->input('brief_id');
            $briefType = $request->input('brief_type', 'common');
            
            if (!$dealId || !$briefId) {
                return response()->json([
                    'success' => false,
                    'message' => '–ù–µ —É–∫–∞–∑–∞–Ω ID —Å–¥–µ–ª–∫–∏ –∏–ª–∏ –±—Ä–∏—Ñ–∞'
                ], 400);
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–¥–µ–ª–∫–µ
            $deal = Deal::find($dealId);
            
            if (!$deal) {
                return response()->json([
                    'success' => false,
                    'message' => '–°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
                ], 404);
            }
            
            // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –±—Ä–∏—Ñ–∞ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –µ–≥–æ –∫ —Å–¥–µ–ª–∫–µ
            if ($briefType === 'common') {
                $brief = Common::find($briefId);
                
                if (!$brief) {
                    return response()->json([
                        'success' => false,
                        'message' => '–ë—Ä–∏—Ñ –Ω–µ –Ω–∞–π–¥–µ–Ω'
                    ], 404);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –∫ —Å–¥–µ–ª–∫–µ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –±—Ä–∏—Ñ
                if (!empty($deal->common_id) && $deal->common_id != $briefId) {
                    return response()->json([
                        'success' => false,
                        'message' => '–ö —Å–¥–µ–ª–∫–µ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –¥—Ä—É–≥–æ–π –æ–±—â–∏–π –±—Ä–∏—Ñ'
                    ], 400);
                }
                
                // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –±—Ä–∏—Ñ –∫ —Å–¥–µ–ª–∫–µ
                $deal->common_id = $briefId;
                $deal->save();
                
                // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ deal_id –≤ –±—Ä–∏—Ñ–µ
                $brief->deal_id = $dealId;
                $brief->save();
            } elseif ($briefType === 'commercial') {
                $brief = Commercial::find($briefId);
                
                if (!$brief) {
                    return response()->json([
                        'success' => false,
                        'message' => '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –±—Ä–∏—Ñ –Ω–µ –Ω–∞–π–¥–µ–Ω'
                    ], 404);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –∫ —Å–¥–µ–ª–∫–µ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –±—Ä–∏—Ñ
                if (!empty($deal->commercial_id) && $deal->commercial_id != $briefId) {
                    return response()->json([
                        'success' => false,
                        'message' => '–ö —Å–¥–µ–ª–∫–µ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –¥—Ä—É–≥–æ–π –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –±—Ä–∏—Ñ'
                    ], 400);
                }
                
                // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –±—Ä–∏—Ñ –∫ —Å–¥–µ–ª–∫–µ
                $deal->commercial_id = $briefId;
                $deal->save();
                
                // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ deal_id –≤ –±—Ä–∏—Ñ–µ
                $brief->deal_id = $dealId;
                $brief->save();
            } else {
                return response()->json([
                    'success' => false,
                    'message' => '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –±—Ä–∏—Ñ–∞'
                ], 400);
            }
            
            return response()->json([
                'success' => true,
                'message' => '–ë—Ä–∏—Ñ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–¥–µ–ª–∫–µ',
                'reload_required' => true
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –±—Ä–∏—Ñ–∞: ' . $e->getMessage()
            ], 500);
        }
    }
    
    /**
     * –û—Ç–≤—è–∑–∫–∞ –±—Ä–∏—Ñ–∞ –æ—Ç —Å–¥–µ–ª–∫–∏
     *
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function unlinkBriefFromDeal(Request $request)
    {
        try {
            $dealId = $request->input('deal_id');
            $briefType = $request->input('brief_type', 'common');
            
            if (!$dealId) {
                return response()->json([
                    'success' => false,
                    'message' => '–ù–µ —É–∫–∞–∑–∞–Ω ID —Å–¥–µ–ª–∫–∏'
                ], 400);
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–¥–µ–ª–∫–µ
            $deal = Deal::find($dealId);
            
            if (!$deal) {
                return response()->json([
                    'success' => false,
                    'message' => '–°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
                ], 404);
            }
            
            // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ—Ç–≤—è–∑—ã–≤–∞–µ–º –±—Ä–∏—Ñ –æ—Ç —Å–¥–µ–ª–∫–∏
            if ($briefType === 'common') {
                if (empty($deal->common_id)) {
                    return response()->json([
                        'success' => false,
                        'message' => '–ö —Å–¥–µ–ª–∫–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –æ–±—â–∏–π –±—Ä–∏—Ñ'
                    ], 400);
                }
                
                // –ù–∞—Ö–æ–¥–∏–º –±—Ä–∏—Ñ –∏ –æ—Ç–≤—è–∑—ã–≤–∞–µ–º –µ–≥–æ –æ—Ç —Å–¥–µ–ª–∫–∏
                $brief = Common::find($deal->common_id);
                if ($brief) {
                    $brief->deal_id = null;
                    $brief->save();
                }
                
                // –û—Ç–≤—è–∑—ã–≤–∞–µ–º –±—Ä–∏—Ñ –æ—Ç —Å–¥–µ–ª–∫–∏
                $deal->common_id = null;
                $deal->save();
            } elseif ($briefType === 'commercial') {
                if (empty($deal->commercial_id)) {
                    return response()->json([
                        'success' => false,
                        'message' => '–ö —Å–¥–µ–ª–∫–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –±—Ä–∏—Ñ'
                    ], 400);
                }
                
                // –ù–∞—Ö–æ–¥–∏–º –±—Ä–∏—Ñ –∏ –æ—Ç–≤—è–∑—ã–≤–∞–µ–º –µ–≥–æ –æ—Ç —Å–¥–µ–ª–∫–∏
                $brief = Commercial::find($deal->commercial_id);
                if ($brief) {
                    $brief->deal_id = null;
                    $brief->save();
                }
                
                // –û—Ç–≤—è–∑—ã–≤–∞–µ–º –±—Ä–∏—Ñ –æ—Ç —Å–¥–µ–ª–∫–∏
                $deal->commercial_id = null;
                $deal->save();
            } else {
                return response()->json([
                    'success' => false,
                    'message' => '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –±—Ä–∏—Ñ–∞'
                ], 400);
            }
            
            return response()->json([
                'success' => true,
                'message' => '–ë—Ä–∏—Ñ —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤—è–∑–∞–Ω –æ—Ç —Å–¥–µ–ª–∫–∏'
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–≤—è–∑–∫–µ –±—Ä–∏—Ñ–∞: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤.
     * 
     * @param Request $request
     * @param Deal $deal
     * @param string $field –ò–º—è –ø–æ–ª—è —Å —Ñ–∞–π–ª–æ–º
     * @param string|null $targetField –ò–º—è –ø–æ–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—É—Ç–∏
     * @return array –ú–∞—Å—Å–∏–≤ —Å –ø—É—Ç—è–º–∏ –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º
     */
    private function handleFileUpload(Request $request, $deal, $field, $targetField = null)
    {
        if ($request->hasFile($field) && $request->file($field)->isValid()) {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏ "avatar", –∏ "avatar_path" –∫–∞–∫ –∞–≤–∞—Ç–∞—Ä —Å–¥–µ–ª–∫–∏
            if ($field === 'avatar' || $field === 'avatar_path') {
                $dir = "dels/{$deal->id}"; // –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–∞–ø–∫—É dels/{id —Å–¥–µ–ª–∫–∏}
                $fileName = "avatar." . $request->file($field)->getClientOriginalExtension(); // –ò–º—è —Ñ–∞–π–ª–∞ –≤—Å–µ–≥–¥–∞ "avatar"
            } else {
                $dir = "dels/{$deal->id}";
                $fileName = $field . '.' . $request->file($field)->getClientOriginalExtension();
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, –∏ —Å–æ–∑–¥–∞–µ–º –µ—ë –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
            $fullPath = storage_path("app/public/{$dir}");
            if (!file_exists($fullPath)) {
                mkdir($fullPath, 0755, true);
            }
            
            $filePath = $request->file($field)->storeAs($dir, $fileName, 'public');
            
            // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞
            Log::info('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', [
                'deal_id' => $deal->id,
                'field' => $field,
                'path' => $filePath
            ]);
            
            return [$targetField ?? $field => $filePath]; // –î–ª—è –∞–≤–∞—Ç–∞—Ä–∞ "avatar_path" –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—É—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        }
        return [];
    }

    /**
     * –ü–æ–∏—Å–∫ –±—Ä–∏—Ñ–æ–≤ –ø–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–ª–∏–µ–Ω—Ç–∞)
     *
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function findBriefsByUserId(Request $request)
    {
        try {
            $dealId = $request->input('deal_id');
            $userId = $request->input('user_id');
            
            if (!$dealId) {
                return response()->json([
                    'success' => false,
                    'message' => '–ù–µ —É–∫–∞–∑–∞–Ω ID —Å–¥–µ–ª–∫–∏'
                ], 400);
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–¥–µ–ª–∫–µ
            $deal = Deal::find($dealId);
            
            if (!$deal) {
                return response()->json([
                    'success' => false,
                    'message' => '–°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
                ], 404);
            }
            
            // –ï—Å–ª–∏ user_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –ø—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –µ–≥–æ –∏–∑ —Å–¥–µ–ª–∫–∏
            if (!$userId && !empty($deal->user_id)) {
                $userId = $deal->user_id;
                \Log::info('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ user_id –∏–∑ —Å–¥–µ–ª–∫–∏', ['deal_id' => $dealId, 'user_id' => $userId]);
            }
            
            if (!$userId) {
                return response()->json([
                    'success' => false,
                    'message' => '–ù–µ –Ω–∞–π–¥–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –±—Ä–∏—Ñ–æ–≤'
                ], 400);
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            $user = \App\Models\User::find($userId);
            
            if (!$user) {
                return response()->json([
                    'success' => false,
                    'message' => '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'
                ], 404);
            }
            
            \Log::info('–ü–æ–∏—Å–∫ –±—Ä–∏—Ñ–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', [
                'deal_id' => $dealId,
                'user_id' => $userId,
                'user_name' => $user->name
            ]);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –±—Ä–∏—Ñ–æ–≤ –≤ —Å–¥–µ–ª–∫–µ
            $hasAttachedBrief = !empty($deal->common_id) || !empty($deal->commercial_id);
            $attachedBriefType = !empty($deal->common_id) ? 'common' : (!empty($deal->commercial_id) ? 'commercial' : null);
            
            // –ü–æ–ª—É—á–∞–µ–º –±—Ä–∏—Ñ—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
            // –û–±—â–∏–µ –±—Ä–∏—Ñ—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π" –∏–ª–∏ "–ó–∞–≤–µ—Ä—à–µ–Ω"
            $commonBriefs = \App\Models\Common::where('user_id', $userId)
                ->whereIn('status', ['–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π', '–ó–∞–≤–µ—Ä—à–µ–Ω'])
                ->where(function($query) use ($dealId) {
                    $query->whereNull('deal_id')  // –¢–æ–ª—å–∫–æ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –±—Ä–∏—Ñ—ã
                          ->orWhere('deal_id', $dealId); // –ò–ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —Ç–µ–∫—É—â–µ–π —Å–¥–µ–ª–∫–µ
                })
                ->get()
                ->map(function($brief) use ($dealId, $user) {
                    return [
                        'id' => $brief->id,
                        'title' => $brief->title ?? ('–ë—Ä–∏—Ñ #' . $brief->id),
                        'user_id' => $brief->user_id,
                        'user_name' => $user->name,
                        'created_at' => $brief->created_at->format('d.m.Y H:i'),
                        'already_linked' => $brief->deal_id == $dealId
                    ];
                })
                ->toArray();
            
            \Log::info('–ù–∞–π–¥–µ–Ω—ã –æ–±—â–∏–µ –±—Ä–∏—Ñ—ã', ['count' => count($commonBriefs)]);
            
            // –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –±—Ä–∏—Ñ—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π" –∏–ª–∏ "–ó–∞–≤–µ—Ä—à–µ–Ω"
            $commercialBriefs = \App\Models\Commercial::where('user_id', $userId)
                ->whereIn('status', ['–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π', '–ó–∞–≤–µ—Ä—à–µ–Ω'])
                ->where(function($query) use ($dealId) {
                    $query->whereNull('deal_id')  // –¢–æ–ª—å–∫–æ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –±—Ä–∏—Ñ—ã
                          ->orWhere('deal_id', $dealId); // –ò–ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —Ç–µ–∫—É—â–µ–π —Å–¥–µ–ª–∫–µ
                })
                ->get()
                ->map(function($brief) use ($dealId, $user) {
                    return [
                        'id' => $brief->id,
                        'title' => $brief->title ?? ('–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –±—Ä–∏—Ñ #' . $brief->id),
                        'user_id' => $brief->user_id,
                        'user_name' => $user->name,
                        'created_at' => $brief->created_at->format('d.m.Y H:i'),
                        'already_linked' => $brief->deal_id == $dealId
                    ];
                })
                ->toArray();
            
            \Log::info('–ù–∞–π–¥–µ–Ω—ã –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –±—Ä–∏—Ñ—ã', ['count' => count($commercialBriefs)]);
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
            $usersInfo = [[
                'id' => $user->id,
                'name' => $user->name,
                'email' => $user->email,
                'phone' => $user->phone
            ]];
            
            return response()->json([
                'success' => true,
                'users' => $usersInfo,
                'briefs' => $commonBriefs,
                'commercials' => $commercialBriefs,
                'has_attached_brief' => $hasAttachedBrief,
                'attached_brief_type' => $attachedBriefType,
                'user_id' => $userId,
                'message' => count($commonBriefs) + count($commercialBriefs) > 0 
                    ? '–ù–∞–π–¥–µ–Ω—ã –±—Ä–∏—Ñ—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞' 
                    : '–ë—Ä–∏—Ñ—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞'
            ]);
        } catch (\Exception $e) {
            \Log::error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –±—Ä–∏—Ñ–æ–≤ –ø–æ user_id: ' . $e->getMessage(), [
                'exception' => $e,
                'trace' => $e->getTraceAsString()
            ]);
            
            return response()->json([
                'success' => false,
                'message' => '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –±—Ä–∏—Ñ–æ–≤: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å–¥–µ–ª–∫–∏
     *
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function uploadDocuments(Request $request)
    {
        try {
            $dealId = $request->input('deal_id');
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö - —É–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤
            $validator = Validator::make($request->all(), [
                'deal_id' => 'required|exists:deals,id',
                'documents' => 'required|array',
                'documents.*' => 'file', // –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ' . implode(', ', $validator->errors()->all())
                ], 422);
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–¥–µ–ª–∫—É
            $deal = Deal::findOrFail($dealId);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
            if (!in_array(Auth::user()->status, ['coordinator', 'partner', 'admin'])) {
                return response()->json([
                    'success' => false,
                    'message' => '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤'
                ], 403);
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã
            $uploadedDocuments = [];
            $directory = "deals/{$dealId}/documents";
            
            // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            $fullPath = storage_path("app/public/{$directory}");
            if (!file_exists($fullPath)) {
                mkdir($fullPath, 0755, true);
            }
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            foreach ($request->file('documents') as $file) {
                if ($file->isValid()) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞, –Ω–æ –¥–µ–ª–∞–µ–º –µ–≥–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º
                    $originalName = $file->getClientOriginalName();
                    $fileName = pathinfo($originalName, PATHINFO_FILENAME);
                    $safeFileName = preg_replace('/[^a-zA-Z0-9_.-]/', '_', $fileName);
                    $extension = $file->getClientOriginalExtension();
                    $uniqueFileName = $safeFileName . '_' . time() . '_' . uniqid() . '.' . $extension;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
                    $path = $file->storeAs($directory, $uniqueFileName, 'public');
                    
                    if ($path) {
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
                        $icon = $this->getFileIconClass($extension);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        $uploadedDocuments[] = [
                            'name' => $originalName,
                            'path' => $path,
                            'url' => url('storage/' . $path),
                            'extension' => $extension,
                            'icon' => $icon
                        ];
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Å–¥–µ–ª–∫–µ
            $currentDocuments = $deal->documents ? 
                (is_string($deal->documents) ? json_decode($deal->documents, true) : $deal->documents) : 
                [];
            
            if (!is_array($currentDocuments)) {
                $currentDocuments = [];
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø—É—Ç–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
            $documentPaths = [];
            foreach ($uploadedDocuments as $doc) {
                $documentPaths[] = $doc['path'];
            }
            
            $allDocuments = array_merge($currentDocuments, $documentPaths);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            $deal->documents = json_encode($allDocuments);
            $deal->save();
            
            return response()->json([
                'success' => true,
                'message' => '–î–æ–∫—É–º–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã',
                'documents' => $uploadedDocuments
            ]);
            
        } catch (\Exception $e) {
            Log::error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ' . $e->getMessage(), [
                'exception' => $e,
                'deal_id' => $request->input('deal_id')
            ]);
            
            return response()->json([
                'success' => false,
                'message' => '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ' . $e->getMessage()
            ], 500);
        }
    }
    
    /**
     * –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–ª–∞—Å—Å –∏–∫–æ–Ω–∫–∏ —Ñ–∞–π–ª–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
     *
     * @param string $extension
     * @return string
     */
    private function getFileIconClass($extension)
    {
        $extension = strtolower($extension);
        
        switch ($extension) {
            case 'pdf':
                return 'fa-file-pdf';
            case 'doc':
            case 'docx':
                return 'fa-file-word';
            case 'xls':
            case 'xlsx':
                return 'fa-file-excel';
            case 'ppt':
            case 'pptx':
                return 'fa-file-powerpoint';
            case 'zip':
            case 'rar':
            case '7z':
                return 'fa-file-archive';
            case 'jpg':
            case 'jpeg':
            case 'png':
            case 'gif':
            case 'webp':
            case 'svg':
            case 'bmp':
                return 'fa-file-image';
            case 'txt':
                return 'fa-file-alt';
            case 'mp4':
            case 'avi':
            case 'mov':
            case 'wmv':
                return 'fa-file-video';
            case 'mp3':
            case 'wav':
            case 'ogg':
                return 'fa-file-audio';
            case 'html':
            case 'css':
            case 'js':
            case 'php':
            case 'json':
            case 'xml':
                return 'fa-file-code';
            default:
                return 'fa-file';
        }
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏
     * –ó–∞–º–µ–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞ –ø–æ–ª–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
     */
    public function editDealPage($dealId)
    {
        try {
            // –ü–æ–ª—É—á–∞–µ–º —Å–¥–µ–ª–∫—É —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ —Å–≤—è–∑—è–º–∏
            $deal = Deal::with([
                'coordinator',
                'partner', 
                'architect',
                'designer',
                'visualizer',
                'dealFeeds.user',
                'dealFeeds' => function($q) {
                    $q->orderBy('created_at', 'desc');
                },
                'users'
            ])->findOrFail($dealId);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–¥–µ–ª–∫–µ
            $user = Auth::user();
            $hasAccess = false;
            
            // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Å–¥–µ–ª–∫–∞–º
            if (in_array($user->status, ['admin', 'coordinator'])) {
                $hasAccess = true;
            }
            // –ü–∞—Ä—Ç–Ω–µ—Ä –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–∏–º —Å–¥–µ–ª–∫–∞–º
            elseif ($user->status === 'partner' && $deal->office_partner_id === $user->id) {
                $hasAccess = true;
            }
            // –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º –∏–º —Å–¥–µ–ª–∫–∞–º
            elseif ($deal->architect_id === $user->id || 
                     $deal->designer_id === $user->id || 
                     $deal->visualizer_id === $user->id) {
                $hasAccess = true;
            }
            // –ö–ª–∏–µ–Ω—Ç –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Å–≤–æ–∏–º —Å–¥–µ–ª–∫–∞–º
            elseif ($deal->user_id === $user->id) {
                $hasAccess = true;
            }
            
            if (!$hasAccess) {
                return redirect()->route('deal.cardinator')
                    ->with('error', '–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Å–¥–µ–ª–∫–µ');
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–ª–µ–π —Å–¥–µ–ª–∫–∏
            $dealFields = $this->getDealFields($deal);
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ä–º—ã
            $coordinators = \App\Models\User::where('status', 'coordinator')->get();
            $partners = \App\Models\User::where('status', 'partner')->get();
            $architects = \App\Models\User::where('status', 'architect')->get();
            $designers = \App\Models\User::where('status', 'designer')->get();
            $visualizers = \App\Models\User::where('status', 'visualizer')->get();
            
            // –ü–æ–ª—É—á–∞–µ–º –≥–æ—Ä–æ–¥–∞ –∏–∑ JSON —Ñ–∞–π–ª–∞
            $citiesFile = public_path('cities.json');
            $russianCities = [];
            if (file_exists($citiesFile)) {
                $citiesJson = file_get_contents($citiesFile);
                $russianCities = json_decode($citiesJson, true) ?: [];
            }
            
            // –°—Ç–∞—Ç—É—Å—ã —Å–¥–µ–ª–æ–∫
            $statuses = [
                '–ñ–¥–µ–º –¢–ó', '–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞', '–ö–æ–ª–ª–∞–∂–∏', '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è', '–†–∞–±–æ—á–∫–∞/—Å–±–æ—Ä –ò–ü',
                '–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤', '–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω', '–ü—Ä–æ–µ–∫—Ç –Ω–∞ –ø–∞—É–∑–µ', '–í–æ–∑–≤—Ä–∞—Ç',
                '–í —Ä–∞–±–æ—Ç–µ', '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π', '–ù–∞ –ø–æ—Ç–æ–º', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                '–ë—Ä–∏—Ñ –ø—Ä–∏–∫—Ä–∏–ø–ª–µ–Ω', '–ü–æ–¥–¥–µ—Ä–∂–∫–∞', '–ê–∫—Ç–∏–≤–Ω—ã–π'
            ];
            
            // –ü–∞–∫–µ—Ç—ã —É—Å–ª—É–≥
            $packages = [
                '–°—Ç–∞–Ω–¥–∞—Ä—Ç',
                '–ü—Ä–µ–º–∏—É–º', 
                '–õ—é–∫—Å'
            ];
            
            // –û–ø—Ü–∏–∏ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
            $priceServiceOptions = [
                '–ó–∞ –º¬≤',
                '–ó–∞ –æ–±—ä–µ–∫—Ç',
                '–ü–æ—á–∞—Å–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞'
            ];
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            $title_site = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ #{$deal->id} - {$deal->client_name}";
            
            Log::info('–û—Ç–∫—Ä—ã—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏', [
                'deal_id' => $deal->id,
                'user_id' => $user->id,
                'user_status' => $user->status
            ]);
            
            return view('deals.edit', compact(
                'deal',
                'title_site',
                'coordinators',
                'partners', 
                'architects',
                'designers',
                'visualizers',
                'russianCities',
                'statuses',
                'packages',
                'priceServiceOptions',
                'dealFields'
            ));
            
        } catch (\Exception $e) {
            Log::error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏', [
                'deal_id' => $dealId,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            
            return redirect()->route('deal.cardinator')
                ->with('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–¥–µ–ª–∫–∏: ' . $e->getMessage());
        }
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–æ–ª–µ–π —Å–¥–µ–ª–∫–∏ –¥–ª—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
     * –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ DealModalController –¥–ª—è –ø–æ–ª–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
     */
    private function getDealFields($deal = null) {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–æ–ª–µ–π
        $coordinators = User::where('status', 'coordinator')->pluck('name', 'id')->toArray();
        $partners = User::where('status', 'partner')->pluck('name', 'id')->toArray();
        $architects = User::where('status', 'architect')->pluck('name', 'id')->toArray();
        $designers = User::where('status', 'designer')->pluck('name', 'id')->toArray();
        $visualizers = User::where('status', 'visualizer')->pluck('name', 'id')->toArray();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ –æ–ø—Ü–∏–∏ –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–æ–≤ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–±—Ä–æ—Å–∞ –≤—ã–±–æ—Ä–∞
        $coordinators = ['' => '-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞ --'] + $coordinators;
        $partners = ['' => '-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ --'] + $partners;
        $architects = ['' => '-- –í—ã–±–µ—Ä–∏—Ç–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–∞ --'] + $architects;
        $designers = ['' => '-- –í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∑–∞–π–Ω–µ—Ä–∞ --'] + $designers;
        $visualizers = ['' => '-- –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ --'] + $visualizers;
        
        return [
            'zakaz' => [
                [
                    'name' => 'client_phone',
                    'icon' => 'fas fa-phone',
                    'type' => 'text',
                    'label' => '–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞',
                    'role' => ['coordinator', 'partner', 'admin'],
                    'required' => true,
                    'class' => 'maskphone',
                    'id' => 'client_phone',
                ],
                [
                    'name' => 'project_number',
                    'label' => '‚Ññ –ø—Ä–æ–µ–∫—Ç–∞',
                    'type' => 'text',
                    'role' => ['coordinator', 'admin'],
                    'maxlength' => 150,
                    'icon' => 'fas fa-hashtag',
                    'required' => true,
                    'description' => '–û—Å–Ω–æ–≤–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–¥–µ–ª–∫–∏',
                ],
                [
                    'name' => 'client_name',
                    'label' => '–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞',
                    'type' => 'text',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'maxlength' => 255,
                    'icon' => 'fas fa-user',
                    'required' => true,
                    'description' => '–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —Å–¥–µ–ª–∫–µ',
                ],
                [
                    'name' => 'avatar_path',
                    'label' => '–ê–≤–∞—Ç–∞—Ä —Å–¥–µ–ª–∫–∏',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin'],
                    'accept' => 'image/*',
                    'icon' => 'fas fa-image',
                ],
                [
                    'name' => 'status',
                    'label' => '–°—Ç–∞—Ç—É—Å',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin'],
                    'options' => [
                        '–ñ–¥–µ–º –¢–ó' => '–ñ–¥–µ–º –¢–ó',
                        '–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞' => '–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞',
                        '–ö–æ–ª–ª–∞–∂–∏' => '–ö–æ–ª–ª–∞–∂–∏',
                        '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è' => '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è',
                        '–†–∞–±–æ—á–∫–∞/—Å–±–æ—Ä –ò–ü' => '–†–∞–±–æ—á–∫–∞/—Å–±–æ—Ä –ò–ü',
                        '–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤' => '–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤',
                        '–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω' => '–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω',
                        '–ü—Ä–æ–µ–∫—Ç –Ω–∞ –ø–∞—É–∑–µ' => '–ü—Ä–æ–µ–∫—Ç –Ω–∞ –ø–∞—É–∑–µ',
                        '–í–æ–∑–≤—Ä–∞—Ç' => '–í–æ–∑–≤—Ä–∞—Ç',
                        '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' => '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                        '–ë—Ä–∏—Ñ –ø—Ä–∏–∫—Ä–∏–ø–ª–µ–Ω' => '–ë—Ä–∏—Ñ –ø—Ä–∏–∫—Ä–∏–ø–ª–µ–Ω',
                    ],
                    'selected' => $deal ? $deal->status : null,
                    'icon' => 'fas fa-tag',
                ],
                [
                    'name' => 'coordinator_id',
                    'label' => '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin'],
                    'options' => $coordinators,
                    'selected' => $deal ? $deal->coordinator_id : null,
                    'icon' => 'fas fa-user-tie',
                ],
                [
                    'name' => 'client_timezone',
                    'label' => '–ì–æ—Ä–æ–¥/—á–∞—Å–æ–≤–æ–π –ø–æ—è—Å',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => [],
                    'selected' => $deal ? $deal->client_timezone : null,
                    'icon' => 'fas fa-city',
                ],
                [
                    'name' => 'office_partner_id',
                    'label' => '–ü–∞—Ä—Ç–Ω–µ—Ä',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin'],
                    'options' => $partners,
                    'selected' => $deal ? $deal->office_partner_id : null,
                    'icon' => 'fas fa-handshake',
                ],
                [
                    'name' => 'package',
                    'label' => '–ü–∞–∫–µ—Ç',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => [
                        '–ü–µ—Ä–≤—ã–π –ø–∞–∫–µ—Ç 1400 –º2' => '–ü–µ—Ä–≤—ã–π –ø–∞–∫–µ—Ç 1400 –º2',
                        '–í—Ç–æ—Ä–æ–π –ø–∞–∫–µ—Ç 85% –∫–æ–º–∏—Å—Å–∏—è' => '–í—Ç–æ—Ä–æ–π –ø–∞–∫–µ—Ç 85% –∫–æ–º–∏—Å—Å–∏—è',
                        '–¢—Ä–µ—Ç–∏–π –ø–∞–∫–µ—Ç 55% –∫–æ–º–∏—Å—Å–∏—è' => '–¢—Ä–µ—Ç–∏–π –ø–∞–∫–µ—Ç 55% –∫–æ–º–∏—Å—Å–∏—è',
                        '–ü–∞—Ä—Ç–Ω–µ—Ä 75% –∫–æ–º–∏—Å—Å–∏—è' => '–ü–∞—Ä—Ç–Ω–µ—Ä 75% –∫–æ–º–∏—Å—Å–∏—è',
                    ],
                    'selected' => $deal ? $deal->package : null,
                    'icon' => 'fas fa-box',
                ],
                [
                    'name' => 'price_service_option',
                    'label' => '–£—Å–ª—É–≥–∞ –ø–æ –ø—Ä–∞–π—Å—É',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => [
                        '—ç–∫—Å–ø—Ä–µ—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞' => '–≠–∫—Å–ø—Ä–µ—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ —Å –∫–æ–ª–ª–∞–∂–∞–º–∏' => '–≠–∫—Å–ø—Ä–µ—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ —Å –∫–æ–ª–ª–∞–∂–∞–º–∏',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å –ø—Ä–æ–µ–∫—Ç —Å —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–π' => '–≠–∫—Å–ø—Ä–µ—Å—Å –ø—Ä–æ–µ–∫—Ç —Å —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–π',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ —Å —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–π –∏ –∫–æ–ª–ª–∞–∂–∞–º–∏' => '–≠–∫—Å–ø—Ä–µ—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ —Å —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–π –∏ –∫–æ–ª–ª–∞–∂–∞–º–∏',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–µ–∫—Ç' => '–≠–∫—Å–ø—Ä–µ—Å—Å —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–µ–∫—Ç',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å —ç—Å–∫–∏–∑–Ω—ã–π –ø—Ä–æ–µ–∫—Ç —Å —Ä–∞–±–æ—á–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π' => '–≠–∫—Å–ø—Ä–µ—Å—Å —ç—Å–∫–∏–∑–Ω—ã–π –ø—Ä–æ–µ–∫—Ç —Å —Ä–∞–±–æ—á–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å 3D–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å –∫–æ–ª–ª–∞–∂–∞–º–∏' => '—ç–∫—Å–ø—Ä–µ—Å—Å 3D–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å –∫–æ–ª–ª–∞–∂–∞–º–∏ ',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å –ø–æ–ª–Ω—ã–π –¥–∏–∑–∞–π–Ω-–ø—Ä–æ–µ–∫—Ç' => '–≠–∫—Å–ø—Ä–µ—Å—Å –ø–æ–ª–Ω—ã–π –¥–∏–∑–∞–π–Ω-–ø—Ä–æ–µ–∫—Ç',
                        '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –æ–¥–Ω—É –∫–æ–º–Ω–∞—Ç—É' => '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –æ–¥–Ω—É –∫–æ–º–Ω–∞—Ç—É',
                    ],
                    'selected' => $deal ? $deal->price_service_option : null,
                    'required' => true,
                    'icon' => 'fas fa-list-check',
                ],
                [
                    'name' => 'rooms_count_pricing',
                    'label' => '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç –ø–æ –ø—Ä–∞–π—Å—É',
                    'type' => 'text',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-door-open',
                ],
                [
                    'name' => 'completion_responsible',
                    'label' => '–ö—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => [
                        '–∫–ª–∏–µ–Ω—Ç' => '–ö–ª–∏–µ–Ω—Ç',
                        '–ø–∞—Ä—Ç–Ω–µ—Ä' => '–ü–∞—Ä—Ç–Ω–µ—Ä',
                        '—à–æ–ø–∏–Ω–≥-–ª–∏—Å—Ç' => '–®–æ–ø–∏–Ω–≥-–ª–∏—Å—Ç',
                        '–∑–∞–∫—É–ø–∫–∏ –∏ —Å–Ω–∞–±–∂–µ–Ω–∏–µ –æ—Ç –£–ö' => '–ù—É–∂–Ω—ã –∑–∞–∫—É–ø–∫–∏ –∏ —Å–Ω–∞–±–∂–µ–Ω–∏–µ –æ—Ç –£–ö',
                    ],
                    'selected' => $deal ? $deal->completion_responsible : null,
                    'icon' => 'fas fa-clipboard-check',
                ],
                [
                    'name' => 'created_date',
                    'label' => '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏',
                    'type' => 'date',
                    'role' => ['coordinator', 'admin'],
                    'icon' => 'fas fa-calendar-plus',
                ],
                [
                    'name' => 'payment_date',
                    'label' => '–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã',
                    'type' => 'date',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-money-check',
                ],
                [
                    'name' => 'total_sum',
                    'label' => '–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞',
                    'type' => 'number',
                    'role' => ['coordinator', 'admin'],
                    'step' => '0.01',
                    'icon' => 'fas fa-ruble-sign',
                ],
                [
                    'name' => 'comment',
                    'label' => '–û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π',
                    'description' => '–ü–æ–¥—Ä–æ–±–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –æ —Å–¥–µ–ª–∫–µ',
                    'type' => 'textarea',
                    'icon' => 'fas fa-sticky-note',
                    'role' => ['admin', 'coordinator', 'partner'],
                    'maxlength' => 1000,
                ],
                [
                    'name' => 'measurements_file',
                    'label' => '–ó–∞–º–µ—Ä—ã',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => '.pdf,.dwg,image/*',
                    'icon' => 'fas fa-ruler-combined',
                ],
            ],
            'rabota' => [
                [
                    'name' => 'start_date',
                    'label' => '–î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞ —Ä–∞–±–æ—Ç—ã –ø–æ –ø—Ä–æ–µ–∫—Ç—É',
                    'type' => 'date',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-play',
                ],
                [
                    'name' => 'project_duration',
                    'label' => '–û–±—â–∏–π —Å—Ä–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞ (–≤ —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è—Ö)',
                    'type' => 'number',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-hourglass-half',
                ],
                [
                    'name' => 'project_end_date',
                    'label' => '–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
                    'type' => 'date',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-flag-checkered',
                ],
                [
                    'name' => 'architect_id',
                    'label' => '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => $architects,
                    'selected' => $deal ? $deal->architect_id : null,
                    'icon' => 'fas fa-drafting-compass',
                ],
                [
                    'name' => 'designer_id',
                    'label' => '–î–∏–∑–∞–π–Ω–µ—Ä',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => $designers,
                    'selected' => $deal ? $deal->designer_id : null,
                    'icon' => 'fas fa-palette',
                ],
                [
                    'name' => 'visualizer_id',
                    'label' => '–í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => $visualizers,
                    'selected' => $deal ? $deal->visualizer_id : null,
                    'icon' => 'fas fa-eye',
                ],
                [
                    'name' => 'plan_final',
                    'label' => '–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É',
                    'type' => 'url',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-link',
                ],
            ],
            'final' => [
                [
                    'name' => 'measurements_file',
                    'label' => '–ó–∞–º–µ—Ä—ã',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => '.pdf,.doc,.docx,.jpg,.jpeg,.png',
                    'icon' => 'fas fa-ruler',
                    'description' => '–§–∞–π–ª —Å –∑–∞–º–µ—Ä–∞–º–∏ –ø–æ–º–µ—â–µ–Ω–∏–π'
                ],
                [
                    'name' => 'final_project_file',
                    'label' => '–§–∏–Ω–∞–ª –ø—Ä–æ–µ–∫—Ç–∞ (PDF, –¥–æ 1.5–ì–ë)',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => 'application/pdf',
                    'icon' => 'fas fa-file-pdf',
                    'description' => '–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF'
                ],
                [
                    'name' => 'work_act',
                    'label' => '–ê–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç (PDF)',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => 'application/pdf',
                    'icon' => 'fas fa-file-signature',
                    'description' => '–ê–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF'
                ],
                [
                    'name' => 'chat_screenshot',
                    'label' => '–°–∫—Ä–∏–Ω —á–∞—Ç–∞ —Å –æ—Ü–µ–Ω–∫–æ–π –∏ –∞–∫—Ç–æ–º (JPEG)',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => 'image/jpeg,image/jpg,image/png',
                    'icon' => 'fas fa-camera',
                    'description' => '–°–∫—Ä–∏–Ω—à–æ—Ç —á–∞—Ç–∞ —Å –æ—Ü–µ–Ω–∫–æ–π –∏ –∞–∫—Ç–æ–º'
                ],
                [
                    'name' => 'archicad_file',
                    'label' => '–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –∞—Ä—Ö–∏–∫–∞–¥ (pln, dwg)',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => '.pln,.dwg',
                    'icon' => 'fas fa-file-code',
                    'description' => '–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ArchiCAD –∏–ª–∏ AutoCAD'
                ],
            ],
        ];
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö —Å–¥–µ–ª–∫–∏
     */
    private function getDealDocuments($deal)
    {
        $documents = [];
        
        $fileFields = [
            'execution_order_file', 'measurements_file', 'final_floorplan', 'final_collage',
            'final_project_file', 'work_act', 'archicad_file', 'contract_attachment', 
            'plan_final', 'chat_screenshot'
        ];
        
        foreach ($fileFields as $field) {
            $yandexUrlField = "yandex_url_{$field}";
            $originalNameField = "original_name_{$field}";
            
            if (isset($deal->$yandexUrlField) && !empty($deal->$yandexUrlField)) {
                $extension = 'pdf';
                $filename = $deal->$originalNameField ?? "{$field}.pdf";
                
                if (!empty($deal->$originalNameField)) {
                    $extension = pathinfo($deal->$originalNameField, PATHINFO_EXTENSION);
                }
                
                $documents[] = [
                    'id' => $deal->id . '_' . $field,
                    'name' => $filename,
                    'path' => $deal->$yandexUrlField,
                    'extension' => $extension,
                    'icon' => $this->getFileIcon($extension),
                    'url' => $deal->$yandexUrlField,
                    'field' => $field
                ];
            }
        }
        
        return $documents;
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∏–∫–æ–Ω–∫—É –¥–ª—è —Ñ–∞–π–ª–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
     */
    private function getFileIcon($extension)
    {
        $icons = [
            'pdf' => 'fas fa-file-pdf',
            'doc' => 'fas fa-file-word',
            'docx' => 'fas fa-file-word',
            'jpg' => 'fas fa-file-image',
            'jpeg' => 'fas fa-file-image',
            'png' => 'fas fa-file-image',
            'dwg' => 'fas fa-file-code',
            'pln' => 'fas fa-file-code',
        ];
        
        return $icons[strtolower($extension)] ?? 'fas fa-file';
    }
                    'icon' => 'fas fa-envelope',
                    'description' => 'Email –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞',
                ],
                [
                    'name' => 'client_city',
                    'label' => '–ì–æ—Ä–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-map-marker-alt',
                    'description' => '–ì–æ—Ä–æ–¥ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞',
                ],
                [
                    'name' => 'avatar_path',
                    'label' => '–ê–≤–∞—Ç–∞—Ä —Å–¥–µ–ª–∫–∏',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin'],
                    'accept' => 'image/*',
                    'icon' => 'fas fa-image',
                ],
                [
                    'name' => 'status',
                    'label' => '–°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-flag',
                    'description' => '–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏',
                    'options' => [
                        '–ñ–¥–µ–º –¢–ó' => '–ñ–¥–µ–º –¢–ó',
                        '–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞' => '–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞',
                        '–ö–æ–ª–ª–∞–∂–∏' => '–ö–æ–ª–ª–∞–∂–∏',
                        '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è' => '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è',
                        '–†–∞–±–æ—á–∫–∞/—Å–±–æ—Ä –ò–ü' => '–†–∞–±–æ—á–∫–∞/—Å–±–æ—Ä –ò–ü',
                        '–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤' => '–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤',
                        '–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω' => '–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω',
                        '–ü—Ä–æ–µ–∫—Ç –Ω–∞ –ø–∞—É–∑–µ' => '–ü—Ä–æ–µ–∫—Ç –Ω–∞ –ø–∞—É–∑–µ',
                        '–í–æ–∑–≤—Ä–∞—Ç' => '–í–æ–∑–≤—Ä–∞—Ç',
                        '–í —Ä–∞–±–æ—Ç–µ' => '–í —Ä–∞–±–æ—Ç–µ',
                        '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π' => '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π',
                        '–ù–∞ –ø–æ—Ç–æ–º' => '–ù–∞ –ø–æ—Ç–æ–º',
                        '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' => '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                        '–ë—Ä–∏—Ñ –ø—Ä–∏–∫—Ä–∏–ø–ª–µ–Ω' => '–ë—Ä–∏—Ñ –ø—Ä–∏–∫—Ä–∏–ø–ª–µ–Ω',
                        '–ü–æ–¥–¥–µ—Ä–∂–∫–∞' => '–ü–æ–¥–¥–µ—Ä–∂–∫–∞',
                        '–ê–∫—Ç–∏–≤–Ω—ã–π' => '–ê–∫—Ç–∏–≤–Ω—ã–π'
                    ]
                ],
                [
                    'name' => 'coordinator_id',
                    'label' => '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä',
                    'type' => 'select',
                    'role' => ['admin'],
                    'icon' => 'fas fa-user-tie',
                    'description' => '–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞',
                    'options' => $coordinators
                ],
                [
                    'name' => 'client_timezone',
                    'label' => '–ì–æ—Ä–æ–¥/—á–∞—Å–æ–≤–æ–π –ø–æ—è—Å',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => [],
                    'icon' => 'fas fa-city',
                ],
                [
                    'name' => 'office_partner_id',
                    'label' => '–ü–∞—Ä—Ç–Ω–µ—Ä',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin'],
                    'icon' => 'fas fa-handshake',
                    'description' => '–û—Ñ–∏—Å–Ω—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä',
                    'options' => $partners
                ],
                [
                    'name' => 'package',
                    'label' => '–ü–∞–∫–µ—Ç —É—Å–ª—É–≥',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-box',
                    'description' => '–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–∞–∫–µ—Ç —É—Å–ª—É–≥',
                    'options' => [
                        '–ü–µ—Ä–≤—ã–π –ø–∞–∫–µ—Ç 1400 –º2' => '–ü–µ—Ä–≤—ã–π –ø–∞–∫–µ—Ç 1400 –º2',
                        '–í—Ç–æ—Ä–æ–π –ø–∞–∫–µ—Ç 85% –∫–æ–º–∏—Å—Å–∏—è' => '–í—Ç–æ—Ä–æ–π –ø–∞–∫–µ—Ç 85% –∫–æ–º–∏—Å—Å–∏—è',
                        '–¢—Ä–µ—Ç–∏–π –ø–∞–∫–µ—Ç 55% –∫–æ–º–∏—Å—Å–∏—è' => '–¢—Ä–µ—Ç–∏–π –ø–∞–∫–µ—Ç 55% –∫–æ–º–∏—Å—Å–∏—è',
                        '–ü–∞—Ä—Ç–Ω–µ—Ä 75% –∫–æ–º–∏—Å—Å–∏—è' => '–ü–∞—Ä—Ç–Ω–µ—Ä 75% –∫–æ–º–∏—Å—Å–∏—è',
                        '–°—Ç–∞–Ω–¥–∞—Ä—Ç' => '–°—Ç–∞–Ω–¥–∞—Ä—Ç',
                        '–ü—Ä–µ–º–∏—É–º' => '–ü—Ä–µ–º–∏—É–º', 
                        '–õ—é–∫—Å' => '–õ—é–∫—Å'
                    ]
                ],
                [
                    'name' => 'price_service_option',
                    'label' => '–£—Å–ª—É–≥–∞ –ø–æ –ø—Ä–∞–π—Å—É',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => [
                        '—ç–∫—Å–ø—Ä–µ—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞' => '–≠–∫—Å–ø—Ä–µ—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ —Å –∫–æ–ª–ª–∞–∂–∞–º–∏' => '–≠–∫—Å–ø—Ä–µ—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ —Å –∫–æ–ª–ª–∞–∂–∞–º–∏',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å –ø—Ä–æ–µ–∫—Ç —Å —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–π' => '–≠–∫—Å–ø—Ä–µ—Å—Å –ø—Ä–æ–µ–∫—Ç —Å —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–π',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ —Å —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–π –∏ –∫–æ–ª–ª–∞–∂–∞–º–∏' => '–≠–∫—Å–ø—Ä–µ—Å—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ —Å —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–π –∏ –∫–æ–ª–ª–∞–∂–∞–º–∏',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–µ–∫—Ç' => '–≠–∫—Å–ø—Ä–µ—Å—Å —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–µ–∫—Ç',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å —ç—Å–∫–∏–∑–Ω—ã–π –ø—Ä–æ–µ–∫—Ç —Å —Ä–∞–±–æ—á–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π' => '–≠–∫—Å–ø—Ä–µ—Å—Å —ç—Å–∫–∏–∑–Ω—ã–π –ø—Ä–æ–µ–∫—Ç —Å —Ä–∞–±–æ—á–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å 3D–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å –∫–æ–ª–ª–∞–∂–∞–º–∏' => '—ç–∫—Å–ø—Ä–µ—Å—Å 3D–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å –∫–æ–ª–ª–∞–∂–∞–º–∏',
                        '—ç–∫—Å–ø—Ä–µ—Å—Å –ø–æ–ª–Ω—ã–π –¥–∏–∑–∞–π–Ω-–ø—Ä–æ–µ–∫—Ç' => '–≠–∫—Å–ø—Ä–µ—Å—Å –ø–æ–ª–Ω—ã–π –¥–∏–∑–∞–π–Ω-–ø—Ä–æ–µ–∫—Ç',
                        '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –æ–¥–Ω—É –∫–æ–º–Ω–∞—Ç—É' => '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –æ–¥–Ω—É –∫–æ–º–Ω–∞—Ç—É'
                    ],
                    'required' => true,
                    'icon' => 'fas fa-list-check',
                ],
                [
                    'name' => 'rooms_count_pricing',
                    'label' => '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç –ø–æ –ø—Ä–∞–π—Å—É',
                    'type' => 'text',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-door-open',
                ],
                [
                    'name' => 'completion_responsible',
                    'label' => '–ö—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => [
                        '–∫–ª–∏–µ–Ω—Ç' => '–ö–ª–∏–µ–Ω—Ç',
                        '–ø–∞—Ä—Ç–Ω–µ—Ä' => '–ü–∞—Ä—Ç–Ω–µ—Ä',
                        '—à–æ–ø–∏–Ω–≥-–ª–∏—Å—Ç' => '–®–æ–ø–∏–Ω–≥-–ª–∏—Å—Ç',
                        '–∑–∞–∫—É–ø–∫–∏ –∏ —Å–Ω–∞–±–∂–µ–Ω–∏–µ –æ—Ç –£–ö' => '–ù—É–∂–Ω—ã –∑–∞–∫—É–ø–∫–∏ –∏ —Å–Ω–∞–±–∂–µ–Ω–∏–µ –æ—Ç –£–ö',
                    ],
                    'icon' => 'fas fa-clipboard-check',
                ],
                [
                    'name' => 'created_date',
                    'label' => '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏',
                    'type' => 'date',
                    'role' => ['coordinator', 'admin'],
                    'icon' => 'fas fa-calendar-plus',
                ],
                [
                    'name' => 'payment_date',
                    'label' => '–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã',
                    'type' => 'date',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-money-check',
                ],
                [
                    'name' => 'total_sum',
                    'label' => '–û–±—â–∞—è —Å—É–º–º–∞',
                    'type' => 'number',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-ruble-sign',
                    'description' => '–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞',
                    'step' => '0.01',
                ],
                [
                    'name' => 'comment',
                    'label' => '–û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π',
                    'description' => '–ü–æ–¥—Ä–æ–±–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –æ —Å–¥–µ–ª–∫–µ',
                    'type' => 'textarea',
                    'icon' => 'fas fa-sticky-note',
                    'role' => ['admin', 'coordinator', 'partner'],
                    'maxlength' => 1000,
                ],
                [
                    'name' => 'measurements_file',
                    'label' => '–ó–∞–º–µ—Ä—ã',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => '.pdf,.dwg,image/*',
                    'icon' => 'fas fa-ruler-combined',
                ],
            ],
            'rabota' => [
                [
                    'name' => 'start_date',
                    'label' => '–î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞ —Ä–∞–±–æ—Ç—ã –ø–æ –ø—Ä–æ–µ–∫—Ç—É',
                    'type' => 'date',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-play',
                ],
                [
                    'name' => 'project_duration',
                    'label' => '–û–±—â–∏–π —Å—Ä–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞ (–≤ —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è—Ö)',
                    'type' => 'number',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-hourglass-half',
                ],
                [
                    'name' => 'project_end_date',
                    'label' => '–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
                    'type' => 'date',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-flag-checkered',
                ], 
                [
                    'name' => 'architect_id',
                    'label' => '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => $architects,
                    'icon' => 'fas fa-drafting-compass',
                ], 
                [
                    'name' => 'designer_id',
                    'label' => '–î–∏–∑–∞–π–Ω–µ—Ä',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => $designers,
                    'icon' => 'fas fa-palette',
                ],
                [
                    'name' => 'visualizer_id',
                    'label' => '–í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä',
                    'type' => 'select',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'options' => $visualizers,
                    'icon' => 'fas fa-eye',
                ],
                [
                    'name' => 'plan_final',
                    'label' => '–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ —Ñ–∏–Ω–∞–ª (PDF, –¥–æ 1.5–ì–ë)',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => 'application/pdf',
                    'icon' => 'fas fa-map',
                    'description' => '–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF'
                ],
                [
                    'name' => 'final_collage',
                    'label' => '–ö–æ–ª–ª–∞–∂ —Ñ–∏–Ω–∞–ª (PDF, –¥–æ 1.5–ì–ë)',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => 'application/pdf',
                    'icon' => 'fas fa-object-group',
                    'description' => '–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–ª–ª–∞–∂–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF'
                ],
                [
                    'name' => 'visualization_link',
                    'label' => '–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é',
                    'type' => 'url',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'icon' => 'fas fa-link',
                ],
            ],
            'final' => [
                [
                    'name' => 'measurements_file',
                    'label' => '–ó–∞–º–µ—Ä—ã',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => '.pdf,.doc,.docx,.jpg,.jpeg,.png',
                    'icon' => 'fas fa-ruler',
                    'description' => '–§–∞–π–ª —Å –∑–∞–º–µ—Ä–∞–º–∏ –ø–æ–º–µ—â–µ–Ω–∏–π'
                ],
                [
                    'name' => 'final_project_file',
                    'label' => '–§–∏–Ω–∞–ª –ø—Ä–æ–µ–∫—Ç–∞ (PDF, –¥–æ 1.5–ì–ë)',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => 'application/pdf',
                    'icon' => 'fas fa-file-pdf',
                    'description' => '–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF'
                ],
                [
                    'name' => 'work_act',
                    'label' => '–ê–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç (PDF)',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => 'application/pdf',
                    'icon' => 'fas fa-file-signature',
                    'description' => '–ê–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF'
                ],
                [
                    'name' => 'chat_screenshot',
                    'label' => '–°–∫—Ä–∏–Ω —á–∞—Ç–∞ —Å –æ—Ü–µ–Ω–∫–æ–π –∏ –∞–∫—Ç–æ–º (JPEG)',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => 'image/jpeg,image/jpg,image/png',
                    'icon' => 'fas fa-camera',
                    'description' => '–°–∫—Ä–∏–Ω—à–æ—Ç —á–∞—Ç–∞ —Å –æ—Ü–µ–Ω–∫–æ–π –∏ –∞–∫—Ç–æ–º'
                ],
                [
                    'name' => 'archicad_file',
                    'label' => '–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –∞—Ä—Ö–∏–∫–∞–¥ (pln, dwg)',
                    'type' => 'file',
                    'role' => ['coordinator', 'admin', 'partner'],
                    'accept' => '.pln,.dwg',
                    'icon' => 'fas fa-file-code',
                    'description' => '–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ArchiCAD –∏–ª–∏ AutoCAD'
                ],
            ],
            'documents' => [
                // –ü–æ–ª—è –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–î–æ–∫—É–º–µ–Ω—Ç—ã" –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
            ],
            'brief' => [
                // –ü–æ–ª—è –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ë—Ä–∏—Ñ" –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
            ]
        ];
    }

    /**
     * –¢–µ—Å—Ç–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏
     */
    public function testUpdateDeal(Request $request, $id)
    {
        try {
            // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ
            Log::info('–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏', [
                'deal_id' => $id,
                'method' => $request->method(),
                'content_type' => $request->header('Content-Type'),
                'has_files' => $request->hasFile('documents'),
                'input_data' => $request->all()
            ]);
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
            return response()->json([
                'success' => true,
                'message' => '–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ',
                'deal_id' => $id,
                'request_method' => $request->method(),
            ]);
        } catch (\Exception $e) {
            Log::error('–û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            
            return response()->json([
                'success' => false,
                'message' => '–û—à–∏–±–∫–∞: ' . $e->getMessage()
            ], 500);
        }
    }
}
