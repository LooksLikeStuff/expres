<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use App\Services\YandexDiskLargeFileService;
use Illuminate\Support\Facades\Http;
use Exception;

class CheckYandexDiskSystemCommand extends Command
{
    /**
     * The name and signature of the console command.
     */
    protected $signature = 'yandex-disk:check-system 
                            {--full : –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å–∏—Å—Ç–µ–º—ã}
                            {--fix : –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã}';

    /**
     * The console command description.
     */
    protected $description = '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ v3.0';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $this->info('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ v3.0');
        $this->newLine();

        $checks = [
            'checkConfiguration',
            'checkDependencies', 
            'checkAPI',
            'checkRoutes',
            'checkServices',
            'checkFiles',
        ];

        if ($this->option('full')) {
            $checks[] = 'checkYandexDiskConnection';
            $checks[] = 'checkPermissions';
        }

        $passed = 0;
        $failed = 0;

        foreach ($checks as $check) {
            if ($this->$check()) {
                $passed++;
            } else {
                $failed++;
            }
        }

        $this->newLine();
        $this->info("üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:");
        $this->info("‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: {$passed}");
        
        if ($failed > 0) {
            $this->error("‚ùå –ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ: {$failed}");
            return 1;
        } else {
            $this->info("üéâ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!");
            return 0;
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    private function checkConfiguration(): bool
    {
        $this->info('üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...');

        $checks = [
            'YANDEX_DISK_TOKEN' => config('services.yandex_disk.token'),
            'Timeout –Ω–∞—Å—Ç—Ä–æ–π–∫–∞' => config('services.yandex_disk.timeout') === 0,
            'Chunk size' => config('services.yandex_disk.chunk_size', 0) > 0,
            'Max retries' => config('services.yandex_disk.max_retries', 0) > 0,
        ];

        $allPassed = true;

        foreach ($checks as $name => $value) {
            if ($value) {
                $this->line("  ‚úÖ {$name}: OK");
            } else {
                $this->line("  ‚ùå {$name}: –ù–ï –ù–ê–°–¢–†–û–ï–ù–û");
                $allPassed = false;

                if ($this->option('fix')) {
                    $this->warn("  üîß –î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–±–∞–≤—å—Ç–µ –≤ .env: YANDEX_DISK_TOKEN=your_token");
                }
            }
        }

        return $allPassed;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π PHP
     */
    private function checkDependencies(): bool
    {
        $this->info('üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π PHP...');

        $checks = [
            'cURL' => extension_loaded('curl'),
            'JSON' => extension_loaded('json'),
            'FileInfo' => extension_loaded('fileinfo'),
            'OpenSSL' => extension_loaded('openssl'),
            'GuzzleHttp' => class_exists('GuzzleHttp\Client'),
        ];

        $phpSettings = [
            'upload_max_filesize' => $this->parseSize(ini_get('upload_max_filesize')) >= (2 * 1024 * 1024 * 1024),
            'post_max_size' => $this->parseSize(ini_get('post_max_size')) >= (2 * 1024 * 1024 * 1024),
            'memory_limit' => ini_get('memory_limit') === '-1' || $this->parseSize(ini_get('memory_limit')) >= (1024 * 1024 * 1024),
            'max_execution_time' => ini_get('max_execution_time') == 0,
        ];

        $allPassed = true;

        foreach ($checks as $name => $value) {
            if ($value) {
                $this->line("  ‚úÖ {$name}: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
            } else {
                $this->line("  ‚ùå {$name}: –ù–ï –ù–ê–ô–î–ï–ù–û");
                $allPassed = false;
            }
        }

        foreach ($phpSettings as $name => $value) {
            if ($value) {
                $this->line("  ‚úÖ {$name}: " . ini_get($name));
            } else {
                $this->line("  ‚ùå {$name}: " . ini_get($name) . " (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)");
                $allPassed = false;
            }
        }

        return $allPassed;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoints
     */
    private function checkAPI(): bool
    {
        $this->info('üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoints...');

        $endpoints = [
            '/api/yandex-disk/health',
            '/api/ping',
            '/api/keepalive',
        ];

        $allPassed = true;
        $baseUrl = config('app.url', 'http://localhost');

        foreach ($endpoints as $endpoint) {
            try {
                $response = Http::timeout(10)->get($baseUrl . $endpoint);
                
                if ($response->successful()) {
                    $this->line("  ‚úÖ {$endpoint}: OK");
                } else {
                    $this->line("  ‚ùå {$endpoint}: HTTP {$response->status()}");
                    $allPassed = false;
                }
            } catch (Exception $e) {
                $this->line("  ‚ùå {$endpoint}: " . $e->getMessage());
                $allPassed = false;
            }
        }

        return $allPassed;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤
     */
    private function checkRoutes(): bool
    {
        $this->info('üõ£Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤...');

        $routes = [
            'api/yandex-disk/upload',
            'api/yandex-disk/delete', 
            'api/yandex-disk/info',
            'api/yandex-disk/health',
        ];

        $allPassed = true;
        $routeCollection = app('router')->getRoutes();

        foreach ($routes as $route) {
            $found = false;
            foreach ($routeCollection as $r) {
                if (str_contains($r->uri(), $route)) {
                    $found = true;
                    break;
                }
            }

            if ($found) {
                $this->line("  ‚úÖ {$route}: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
            } else {
                $this->line("  ‚ùå {$route}: –ù–ï –ù–ê–ô–î–ï–ù");
                $allPassed = false;
            }
        }

        return $allPassed;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
     */
    private function checkServices(): bool
    {
        $this->info('‚öôÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...');

        try {
            $service = app(YandexDiskLargeFileService::class);
            $this->line("  ‚úÖ YandexDiskLargeFileService: –°–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ");

            $healthCheck = $service->healthCheck();
            if ($healthCheck['status'] === 'ok') {
                $this->line("  ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞: OK");
                $this->line("  üìä –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ: " . ($healthCheck['free_space'] ?? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
            } else {
                $this->line("  ‚ùå –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞: " . ($healthCheck['message'] ?? '–æ—à–∏–±–∫–∞'));
                return false;
            }

            return true;
        } catch (Exception $e) {
            $this->line("  ‚ùå –°–µ—Ä–≤–∏—Å: " . $e->getMessage());
            return false;
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å–∏—Å—Ç–µ–º—ã
     */
    private function checkFiles(): bool
    {
        $this->info('üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å–∏—Å—Ç–µ–º—ã...');

        $files = [
            'app/Services/YandexDiskLargeFileService.php',
            'app/Http/Controllers/Api/YandexDiskController.php',
            'app/Http/Middleware/LargeFileUploadMiddleware.php',
            'public/js/yandex-disk-uploader-v3.js',
            'public/css/yandex-disk-uploader-v3.css',
            'public/js/yandex-disk-modal-integration.js',
            'resources/views/deals/partials/components/field_types/file_v3.blade.php',
            'resources/views/deals/partials/components/yandex_disk_uploader_v3.blade.php',
        ];

        $allPassed = true;
        $basePath = base_path();

        foreach ($files as $file) {
            $fullPath = $basePath . '/' . $file;
            
            if (file_exists($fullPath)) {
                $size = filesize($fullPath);
                $this->line("  ‚úÖ {$file}: " . $this->formatBytes($size));
            } else {
                $this->line("  ‚ùå {$file}: –ù–ï –ù–ê–ô–î–ï–ù");
                $allPassed = false;
            }
        }

        return $allPassed;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–æ–º
     */
    private function checkYandexDiskConnection(): bool
    {
        $this->info('‚òÅÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–æ–º...');

        try {
            $service = app(YandexDiskLargeFileService::class);
            $healthCheck = $service->healthCheck();

            if ($healthCheck['status'] === 'ok') {
                $this->line("  ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: –£—Å–ø–µ—à–Ω–æ");
                $this->line("  üìä –û–±—â–µ–µ –º–µ—Å—Ç–æ: " . ($healthCheck['total_space'] ?? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
                $this->line("  üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: " . ($healthCheck['used_space'] ?? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
                $this->line("  üìä –°–≤–æ–±–æ–¥–Ω–æ: " . ($healthCheck['free_space'] ?? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
                return true;
            } else {
                $this->line("  ‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: " . ($healthCheck['message'] ?? '–æ—à–∏–±–∫–∞'));
                return false;
            }
        } catch (Exception $e) {
            $this->line("  ‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: " . $e->getMessage());
            return false;
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
     */
    private function checkPermissions(): bool
    {
        $this->info('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...');

        $directories = [
            storage_path('logs'),
            storage_path('app/public'),
            public_path('uploads'),
        ];

        $allPassed = true;

        foreach ($directories as $dir) {
            if (!is_dir($dir)) {
                @mkdir($dir, 0755, true);
            }

            if (is_writable($dir)) {
                $this->line("  ‚úÖ " . basename($dir) . ": –î–æ—Å—Ç—É–ø –Ω–∞ –∑–∞–ø–∏—Å—å");
            } else {
                $this->line("  ‚ùå " . basename($dir) . ": –ù–ï–¢ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –∑–∞–ø–∏—Å—å");
                $allPassed = false;

                if ($this->option('fix')) {
                    $this->warn("  üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: chmod 755 {$dir}");
                    @chmod($dir, 0755);
                }
            }
        }

        return $allPassed;
    }

    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –≤ –±–∞–π—Ç—ã
     */
    private function parseSize(string $size): int
    {
        $size = trim($size);
        $last = strtolower($size[strlen($size) - 1]);
        $value = (int) $size;

        switch ($last) {
            case 'g':
                $value *= 1024;
            case 'm':
                $value *= 1024;
            case 'k':
                $value *= 1024;
        }

        return $value;
    }

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
     */
    private function formatBytes(int $bytes, int $precision = 2): string
    {
        $units = ['B', 'KB', 'MB', 'GB', 'TB'];

        for ($i = 0; $bytes > 1024 && $i < count($units) - 1; $i++) {
            $bytes /= 1024;
        }

        return round($bytes, $precision) . ' ' . $units[$i];
    }
}
