# ===== КОНФИГУРАЦИЯ NGINX ДЛЯ МАКСИМАЛЬНОЙ СКОРОСТИ ЗАГРУЗКИ =====
# Настройки для высокоскоростной загрузки больших файлов на Яндекс.Диск

server {
    listen 80;
    server_name localhost;
    root c:/ospanel/domains/back/public;
    index index.php index.html;

    # ===== УБИРАЕМ ВСЕ ОГРАНИЧЕНИЯ НА РАЗМЕР ФАЙЛОВ =====
    client_max_body_size 0;                    # Убираем ограничения размера
    client_body_buffer_size 2m;                # Увеличиваем буфер
    client_body_timeout 86400;                 # 24 часа на загрузку тела
    client_header_timeout 86400;               # 24 часа на заголовки
    
    # ===== ОПТИМИЗАЦИЯ ТАЙМАУТОВ =====
    proxy_connect_timeout 86400;               # 24 часа на соединение с backend
    proxy_send_timeout 86400;                  # 24 часа на отправку
    proxy_read_timeout 86400;                  # 24 часа на чтение
    send_timeout 86400;                        # 24 часа на отправку клиенту
    
    # ===== ОПТИМИЗАЦИЯ БУФЕРИЗАЦИИ =====
    proxy_buffering off;                       # Отключаем буферизацию для потоковой передачи
    proxy_request_buffering off;               # Отключаем буферизацию запросов
    
    # ===== ОПТИМИЗАЦИЯ СОЕДИНЕНИЙ =====
    keepalive_timeout 300;                     # 5 минут keep-alive
    keepalive_requests 10000;                  # Больше запросов на соединение
    
    # ===== НАСТРОЙКИ ДЛЯ БОЛЬШИХ ФАЙЛОВ =====
    client_body_in_file_only clean;            # Сохраняем тело запроса в файл
    client_body_temp_path /tmp/nginx_temp 1 2; # Временная папка для файлов
    
    # ===== ОТКЛЮЧЕНИЕ СЖАТИЯ ДЛЯ СКОРОСТИ =====
    gzip off;                                  # Отключаем gzip для максимальной скорости
    
    # ===== ОПТИМИЗАЦИЯ TCP =====
    tcp_nodelay on;                            # Отключаем алгоритм Нагла
    tcp_nopush on;                             # Включаем TCP_CORK
    
    # ===== ОБРАБОТКА PHP =====
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # ===== УВЕЛИЧИВАЕМ ЛИМИТЫ FASTCGI =====
        fastcgi_connect_timeout 86400;         # 24 часа на соединение
        fastcgi_send_timeout 86400;            # 24 часа на отправку
        fastcgi_read_timeout 86400;            # 24 часа на чтение
        fastcgi_buffer_size 2m;                # Увеличиваем буфер
        fastcgi_buffers 32 2m;                 # Больше буферов
        fastcgi_busy_buffers_size 4m;          # Увеличиваем busy буферы
        fastcgi_temp_file_write_size 4m;       # Размер временных файлов
        fastcgi_max_temp_file_size 0;          # Убираем ограничения временных файлов
        
        # ===== ОТКЛЮЧАЕМ БУФЕРИЗАЦИЮ ДЛЯ ПОТОКОВОЙ ПЕРЕДАЧИ =====
        fastcgi_buffering off;                 # Отключаем буферизацию FastCGI
        fastcgi_request_buffering off;         # Отключаем буферизацию запросов
    }
    
    # ===== СПЕЦИАЛЬНЫЕ НАСТРОЙКИ ДЛЯ ЗАГРУЗКИ =====
    location /deal {
        try_files $uri $uri/ /index.php?$query_string;
        
        # Дополнительные оптимизации для загрузки
        client_max_body_size 0;
        client_body_timeout 86400;
        proxy_request_buffering off;
    }
    
    # ===== СТАТИЧЕСКИЕ ФАЙЛЫ =====
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # ===== БЕЗОПАСНОСТЬ =====
    location ~ /\.ht {
        deny all;
    }
    
    # ===== ЛОГИРОВАНИЕ =====
    access_log /var/log/nginx/turbo_upload_access.log;
    error_log /var/log/nginx/turbo_upload_error.log;
}
