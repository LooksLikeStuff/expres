# Документация: Select2 поля с поиском в модальном окне редактирования сделок

## Обзор

В модальном окне редактирования сделок (`#editDealModal`) реализованы три поля с поиском на основе Select2:

1. **Координатор** - поиск координаторов с AJAX
2. **Партнер** - поиск партнеров с AJAX  
3. **Город/часовой пояс** - поиск городов из JSON файла

## Реализованные компоненты

### 1. HTML-структура (tab_zakaz.blade.php)

Поля используют следующие CSS-классы:
- `select2-coordinator-search` - для поиска координаторов
- `select2-partner-search` - для поиска партнеров
- `select2-cities-search` - для поиска городов

### 2. JavaScript инициализация (scripts.blade.php)

Функция `initModalSelects()` инициализирует все Select2 поля:

#### Координатор:
- **Эндпоинт**: `/search-users?status=coordinator`
- **Минимальная длина**: 0 символов (поиск доступен сразу)
- **Шаблон результата**: имя + email
- **AJAX**: включен

#### Партнер:
- **Эндпоинт**: `/search-users?status=partner`
- **Минимальная длина**: 0 символов
- **Шаблон результата**: имя + email
- **AJAX**: включен

#### Город/часовой пояс:
- **Источник данных**: `/cities.json`
- **Минимальная длина**: 1 символ
- **Группировка**: по регионам
- **Формат данных**: `[{"region": "...", "city": "..."}]`

### 3. CSS-стили (select2-coordinator-partner.css)

Стили обеспечивают:
- Корректное отображение в модальных окнах (z-index)
- Адаптивный дизайн
- Красивые шаблоны результатов
- Правильное позиционирование dropdown

### 4. API эндпоинты (web.php)

#### `/search-users`
```php
GET /search-users?q={query}&status={coordinator|partner}
```

**Параметры:**
- `q` - строка поиска (поиск по имени)
- `status` - статус пользователя (coordinator/partner)

**Ответ:**
```json
[
  {
    "id": 123,
    "name": "Иван Иванов",
    "email": "ivan@example.com",
    "status": "coordinator",
    "avatar_url": "..."
  }
]
```

#### `/cities.json`
Статический JSON файл с городами:
```json
[
  {
    "region": "Москва и Московская обл.",
    "city": "Москва"
  }
]
```

## Диагностика и отладка

### Диагностический скрипт
Создан файл `select2-diagnostic.js` для отладки:

```javascript
// Проверка состояния полей
select2Diagnostic.check();

// Принудительная переинициализация
select2Diagnostic.reinit();
```

### Автоматическая инициализация

1. При загрузке модального окна вызывается `initModalSelects()`
2. При открытии модального окна (`modalOpened`) поля переинициализируются
3. Есть автоматические проверки через setTimeout для динамических элементов

## Устранение неполадок

### Проблема: Поля не инициализируются
**Решение:**
1. Проверить загрузку jQuery и Select2
2. Убедиться, что `initModalSelects()` вызывается
3. Проверить консоль браузера на ошибки

### Проблема: Dropdown не отображается
**Решение:**
1. Проверить z-index в CSS
2. Убедиться, что `dropdownParent` настроен правильно
3. Проверить CSS-стили для модального окна

### Проблема: AJAX не работает
**Решение:**
1. Проверить доступность эндпоинтов `/search-users` и `/cities.json`
2. Проверить аутентификацию (middleware auth)
3. Проверить параметры запроса

### Проблема: Данные не загружаются
**Решение:**
1. Для городов: проверить `/cities.json`
2. Для пользователей: проверить базу данных и фильтры по статусу
3. Проверить логи Laravel

## Технические особенности

1. **Производительность**: AJAX-запросы кэшируются
2. **Безопасность**: аутентификация через middleware
3. **UX**: красивые шаблоны с иконками и рейтингами
4. **Адаптивность**: работает на мобильных устройствах
5. **Локализация**: сообщения на русском языке

## Будущие улучшения

1. Добавить дебаунсинг для AJAX-запросов
2. Кэширование результатов в localStorage
3. Виртуализация для больших списков
4. Поддержка множественного выбора
5. Интеграция с системой уведомлений
