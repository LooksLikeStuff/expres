# Система логирования действий со сделками

## Обзор
Реализована комплексная система логирования всех действий со сделками для административного контроля и мониторинга.

## Основные компоненты

### 1. Таблица логов (`deal_change_logs`)
**Файл миграции:** `database/migrations/2025_07_24_063233_create_deal_change_logs_table.php`

**Поля:**
- `id` - уникальный идентификатор лога
- `deal_id` - ID сделки
- `user_id` - ID пользователя (nullable, если пользователь удален)
- `user_name` - имя пользователя для сохранения истории
- `action_type` - тип действия (create, update, delete, status_change)
- `changes` - JSON с детальными изменениями
- `description` - человекочитаемое описание действия
- `ip_address` - IP адрес пользователя
- `user_agent` - информация о браузере
- `created_at`, `updated_at` - временные метки

### 2. Модель DealChangeLog
**Файл:** `app/Models/DealChangeLog.php`

**Особенности:**
- JSON кастинг для поля `changes`
- Связи с моделями Deal и User
- Скопы для фильтрации (byActionType, byUser, byDateRange, search)
- Метод получения переведенного типа действия

### 3. Observer для автоматического логирования
**Файл:** `app/Observers/DealObserver.php`

**Отслеживаемые события:**
- `created` - создание сделки
- `updated` - обновление сделки
- `deleting` - удаление сделки (перед удалением)
- `deleted` - после удаления
- `restored` - восстановление (если используется soft delete)

### 4. Helper класс
**Файл:** `app/Helpers/DealLogHelper.php`

**Методы:**
- `createLog()` - универсальное создание лога
- `logDealCreation()` - логирование создания
- `logDealUpdate()` - логирование обновления
- `logDealDeletion()` - логирование удаления
- `logCustomAction()` - логирование кастомных действий
- `getLogStatistics()` - получение статистики

### 5. Middleware для логирования запросов
**Файл:** `app/Http/Middleware/DealActionLogger.php`

**Функции:**
- Автоматическое логирование HTTP запросов к сделкам
- Определение типа действия по маршруту и методу
- Извлечение ID сделки из различных источников

### 6. Админ-панель
**Файл:** `resources/views/deals/cardinators.blade.php`

**Компоненты:**
- Блок только для администраторов
- Кнопки быстрого доступа к разным типам логов
- Статистика в реальном времени
- Быстрые фильтры по периодам

### 7. Страница глобальных логов
**Файл:** `resources/views/deals/global_change_logs.blade.php`

**Возможности:**
- Расширенная фильтрация и поиск
- Отображение детальных изменений
- Показ IP адресов и User Agent
- Пагинация результатов
- Экспорт в различные форматы

### 8. Контроллер
**Файл:** `app/Http/Controllers/DealsController.php`

**Метод:** `globalLogs(Request $request)`
- Проверка прав доступа (только admin)
- Применение фильтров через скопы модели
- Получение статистики через Helper
- Возврат отфильтрованных данных

## Маршруты

```php
// Только для координаторов и админов
Route::middleware(['auth', 'status:coordinator,admin'])->group(function () {
    Route::get('/deal/change-logs', [DealsController::class, 'changeLogs'])->name('deal.change_logs');
    Route::get('/deal/{deal}/change-logs', [DealsController::class, 'changeLogsForDeal'])->name('deal.change_logs.deal');
});

// Только для админов
Route::middleware(['auth', 'status:admin'])->group(function () {
    Route::get('/deal/global-logs', [DealsController::class, 'globalLogs'])->name('deal.global_logs');
});
```

## Типы действий

### create
- Автоматически создается при создании новой сделки
- Содержит все поля новой сделки в changes
- action_type: 'create'

### update
- Создается при любом обновлении полей сделки
- Содержит только измененные поля с old/new значениями
- action_type: 'update'

### status_change
- Специальный тип для изменения статуса сделки
- Создается автоматически при изменении поля status
- action_type: 'status_change'

### delete
- Создается перед удалением сделки
- Содержит полную копию данных сделки для возможности восстановления
- action_type: 'delete'

### custom/system
- Для кастомных действий через Helper или Middleware
- Может содержать любые дополнительные данные
- action_type: 'custom' или 'system'

## Безопасность

1. **Контроль доступа:** Только пользователи со статусом 'admin' имеют доступ к глобальным логам
2. **Сохранение истории:** Даже при удалении пользователя, его имя сохраняется в логах
3. **IP и User Agent:** Отслеживание для аудита безопасности
4. **Неизменяемость:** Логи не могут быть отредактированы после создания

## Производительность

1. **Индексы:** Созданы составные индексы для быстрого поиска
2. **Пагинация:** Результаты разбиваются на страницы по 50 записей
3. **Ленивая загрузка:** Связи загружаются только при необходимости
4. **Кэширование статистики:** Статистика может кэшироваться для улучшения производительности

## Использование

### Просмотр логов администратором
1. Зайти на страницу `/deal-cardinator`
2. В верхней части увидеть админ-панель (только для admin)
3. Нажать на нужную кнопку (глобальные логи, логи удалений и т.д.)
4. Использовать фильтры для поиска нужных записей

### Автоматическое логирование
Логирование происходит автоматически через Observer при любых изменениях в модели Deal:
- Создание сделки
- Редактирование полей
- Изменение статуса
- Удаление

### Ручное логирование
```php
use App\Helpers\DealLogHelper;

// Логирование кастомного действия
DealLogHelper::logCustomAction(
    $dealId, 
    'Отправлено уведомление клиенту', 
    ['email' => $clientEmail, 'type' => 'notification']
);
```

## Тестирование

Для тестирования интерфейса без подключения к БД создан файл:
`public/test-admin-logs.html`

Открыть в браузере: `http://your-domain/test-admin-logs.html`
