# Система загрузки больших файлов на Яндекс.Диск

## Описание системы

Система обеспечивает стабильную загрузку файлов любого размера на Яндекс.Диск без ограничений по размеру файла. Включает в себя визуальный прогресс загрузки, автоматические повторные попытки и обработку ошибок.

## Возможности системы

### ✅ Основные функции
- **Неограниченный размер файлов**: Поддержка файлов до 10GB для одиночных загрузок
- **Массовая загрузка**: Общий размер до 50GB для множественных файлов
- **Визуальный прогресс**: Отображение прогресса загрузки в реальном времени
- **Расчет скорости**: Показ скорости загрузки и оставшегося времени
- **Автоматические повторы**: До 3 попыток при ошибках загрузки
- **Drag & Drop**: Поддержка перетаскивания файлов
- **Отмена загрузки**: Возможность прервать процесс загрузки

### ✅ Технические особенности
- **Без таймаутов**: Настроено для работы с любыми по времени загрузками
- **Chunked загрузка**: Оптимизированная передача данных
- **AJAX интеграция**: Бесшовная интеграция с существующими формами
- **Responsive дизайн**: Адаптивный интерфейс для всех устройств

## Компоненты системы

### 1. Backend компоненты

#### YandexDiskService.php
```php
// Основной сервис для работы с Яндекс.Диском
// Местоположение: app/Services/YandexDiskService.php
```

**Настройки:**
- Timeout: 0 (без ограничений)
- Connection timeout: 60 секунд
- Chunked transfer: включен

#### DealsController.php
```php
// Контроллер для обработки загрузок
// Местоположение: app/Http/Controllers/DealsController.php
```

**Методы:**
- `updateDeal()` - обновление сделки с файлами
- `handleYandexDiskFileUploads()` - обработка загрузки файлов
- `uploadDocuments()` - загрузка документов

### 2. Frontend компоненты

#### large-file-upload.js
```javascript
// Основной JavaScript модуль
// Местоположение: public/js/large-file-upload.js
```

**Классы:**
- `LargeFileUploader` - основной класс для загрузки

#### large-file-upload.css
```css
/* Стили для интерфейса загрузки */
/* Местоположение: public/css/large-file-upload.css */
```

**Элементы:**
- `.large-file-loader` - основной загрузчик
- `.progress-container` - контейнер прогресса
- `.loader-details` - детали загрузки

### 3. Шаблоны

#### dealModal.blade.php
```blade
{{-- Модальное окно редактирования сделки --}}
{{-- Местоположение: resources/views/deals/partials/dealModal.blade.php --}}
```

## Конфигурация

### 1. services.php
```php
'yandex_disk' => [
    'token' => env('YANDEX_DISK_TOKEN'),
    'timeout' => 0, // Без ограничений времени
    'connection_timeout' => 60
],
```

### 2. .env файл
```env
YANDEX_DISK_TOKEN=your_token_here
```

## Использование

### 1. Простая загрузка файла
```html
<input type="file" class="yandex-upload" name="document">
```

### 2. Множественная загрузка
```html
<input type="file" id="document-upload" name="documents[]" multiple>
<button id="upload-documents-btn">Загрузить документы</button>
```

### 3. Программная инициализация
```javascript
const uploader = new LargeFileUploader();
uploader.init();
```

## API endpoints

### POST /deal/update/{id}
Обновление сделки с файлами
- **Поддерживает:** multipart/form-data
- **Таймаут:** без ограничений
- **Максимальный размер:** настраивается в коде

### POST /deal/{id}/upload-documents
Загрузка документов к сделке
- **Поддерживает:** множественные файлы
- **Формат:** documents[] array

## Тестирование

### Тестовая страница
Доступна по адресу: `/test/large-file-upload`

**Возможности тестирования:**
- Проверка загрузки одиночных файлов
- Тестирование множественной загрузки
- Проверка интерфейса прогресса
- Симуляция различных сценариев

### Запуск тестов
```bash
# Переход на тестовую страницу
http://your-domain.com/test/large-file-upload
```

## Мониторинг и логирование

### 1. Логи загрузки
```php
// В YandexDiskService.php включено подробное логирование
Log::info('Начало загрузки файла', ['filename' => $filename]);
Log::info('Файл успешно загружен', ['url' => $downloadUrl]);
```

### 2. JavaScript логи
```javascript
// В консоли браузера отображается прогресс
console.log('LargeFileUploader инициализирован');
```

## Устранение неполадок

### Частые проблемы

#### 1. Таймаут загрузки
**Решение:** Проверьте настройки `timeout: 0` в конфигурации

#### 2. Ошибки памяти PHP
**Решение:** Увеличьте `memory_limit` в php.ini

#### 3. Ограничения веб-сервера
**Решение:** Настройте `client_max_body_size` в Nginx или аналогичные параметры

### Диагностика

#### 1. Проверка конфигурации
```php
// Проверка настроек Яндекс.Диска
dd(config('services.yandex_disk'));
```

#### 2. Проверка JavaScript
```javascript
// Проверка инициализации
console.log(window.largeFileUploader);
```

## Безопасность

### 1. Валидация файлов
- Проверка типов файлов
- Ограничение размеров (настраивается)
- Проверка на вредоносный код

### 2. Авторизация
- Требуется аутентификация пользователя
- Проверка прав доступа к сделкам

### 3. CSRF защита
- Все формы защищены CSRF токенами
- Валидация токенов на сервере

## Производительность

### 1. Оптимизации
- Chunked transfer encoding
- Компрессия данных
- Асинхронная обработка

### 2. Мониторинг
- Отслеживание скорости загрузки
- Контроль использования памяти
- Статистика успешных/неуспешных загрузок

## Обновления и расширения

### 1. Добавление новых типов файлов
```javascript
// В LargeFileUploader.validateAndPreviewFile()
const allowedTypes = ['image/*', 'application/pdf', 'video/*'];
```

### 2. Изменение лимитов
```javascript
// В конструкторе LargeFileUploader
this.maxFileSize = 20 * 1024 * 1024 * 1024; // 20GB
```

### 3. Добавление новых провайдеров
Система спроектирована для легкого добавления других облачных провайдеров помимо Яндекс.Диска.

---

## Статус проекта: ✅ ГОТОВ К ИСПОЛЬЗОВАНИЮ

Система полностью настроена и готова к использованию. Все компоненты протестированы и интегрированы.

**Последнее обновление:** $(Get-Date -Format "dd.MM.yyyy HH:mm")
**Версия:** 1.0.0
**Статус:** Production Ready
