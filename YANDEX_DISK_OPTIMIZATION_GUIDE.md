# Руководство по оптимизации YandexDiskService для больших файлов

## Внесенные изменения

### 1. Увеличена минимальная скорость загрузки
- **Было**: 10KB/s  
- **Стало**: 1MB/s
- **Причина**: Более агрессивное обнаружение медленных соединений

### 2. Увеличен таймаут для низкой скорости
- **Было**: 5 минут
- **Стало**: 30 минут  
- **Причина**: Больше времени для загрузки очень больших файлов

### 3. Увеличен размер буферов
- **Было**: 8MB
- **Стало**: 32MB
- **Причина**: Более эффективная передача данных

### 4. Оптимизированы TCP настройки
- Добавлен `TCP_NODELAY` для отключения алгоритма Нейгла
- Оптимизированы настройки `keep-alive`
- Увеличен таймаут соединения до 2 минут

### 5. Добавлено детальное логирование
- Логирование скорости загрузки
- Отслеживание времени загрузки
- Сравнение с минимальными требованиями

## Рекомендации по дальнейшей оптимизации

### 1. Настройки Nginx
Примените конфигурацию из файла `nginx_optimized_large_files.conf`:
```bash
# Включите в ваш nginx.conf
include /path/to/nginx_optimized_large_files.conf;
```

### 2. Настройки PHP-FPM
Примените конфигурацию из файла `php-fpm_optimized.conf`:
```bash
# Скопируйте настройки в ваш pool конфиг
cp php-fpm_optimized.conf /etc/php/8.1/fpm/pool.d/optimized.conf
systemctl reload php8.1-fpm
```

### 2.1. Настройки для OSPanel
Для пользователей OSPanel:
1. Откройте панель управления OSPanel
2. Перейдите в настройки PHP
3. Убедитесь, что включены расширения:
   - `curl`
   - `openssl`
   - `fileinfo`
4. Примените настройки из файла `php.ini`
5. Перезапустите Apache/Nginx в OSPanel

### 3. Переменные окружения .env
Добавьте в ваш .env файл:
```env
# Yandex Disk оптимизация
YANDEX_DISK_MIN_SPEED=1048576     # 1MB/s
YANDEX_DISK_LOW_SPEED_TIME=1800   # 30 минут
YANDEX_DISK_TIMEOUT=0             # Без ограничений
YANDEX_DISK_BUFFER_SIZE=33554432  # 32MB
YANDEX_DISK_CONNECT_TIMEOUT=120   # 2 минуты
```

### 4. Мониторинг производительности
Следите за логами Laravel для анализа производительности:
```bash
tail -f storage/logs/laravel.log | grep "Статистика загрузки"
```

### 5. Дополнительные оптимизации

#### A. Использование асинхронной обработки
Для очень больших файлов рекомендуется использовать очереди Laravel:
```php
// В контроллере
dispatch(new UploadToYandexDiskJob($file, $path));
```

#### B. Прогресс-бар для пользователей
Реализуйте WebSocket или Server-Sent Events для отображения прогресса загрузки.

#### C. Chunked upload
Для файлов > 100MB рассмотрите возможность разбиения на чанки.

## Проблемы и их решения

### Проблема: Ошибка 500 "No application encryption key has been specified"
**Решение**: 
- Проверить корректность файла `.env` (убрать кириллические символы вне комментариев)
- Выполнить команды:
  ```bash
  php artisan config:clear
  php artisan cache:clear
  php artisan route:clear
  php artisan view:clear
  ```

### Проблема: Таймаут соединения
**Решение**: Увеличен `connect_timeout` до 120 секунд

### Проблема: Медленная загрузка
**Решение**: 
- Увеличен размер буферов до 32MB
- Оптимизированы TCP настройки
- Повышена минимальная скорость до 1MB/s

### Проблема: PHP ограничения
**Решение**: 
- Убраны все ограничения на размер файлов
- Установлен безлимитный timeout
- Увеличены буферы памяти

### Проблема: Некорректный файл .env
**Решение**: 
- Все комментарии должны начинаться с символа `#`
- Нельзя использовать кириллические символы вне комментариев
- Проверить правильность формата переменных окружения

## Диагностика и устранение неполадок

### Быстрая диагностика Laravel
```bash
# Проверка работоспособности Laravel
php artisan --version

# Проверка конфигурации
php artisan config:cache

# Проверка подключения к базе данных
php artisan migrate:status

# Тест загрузки файла на Yandex Disk
php artisan tinker
>>> $service = new \App\Services\YandexDiskService();
>>> $service->checkAuth();
```

### Проверка логов ошибок
```bash
# Windows (PowerShell)
Get-Content storage\logs\laravel.log | Select-Object -Last 50

# Linux/macOS
tail -50 storage/logs/laravel.log
```

### Мониторинг производительности в реальном времени
```bash
# Следить за статистикой загрузки
Get-Content storage\logs\laravel.log -Wait | Select-String "Статистика загрузки"

# Отслеживание ошибок
Get-Content storage\logs\laravel.log -Wait | Select-String "ERROR"
```

### Проверка настроек PHP
```bash
# Проверить лимиты PHP
php -i | findstr "upload_max_filesize\|post_max_size\|max_execution_time\|memory_limit"

# Проверить расширения cURL
php -m | findstr curl
```

## Тестирование

Для тестирования производительности используйте:

1. **Небольшие файлы** (< 10MB): Должны загружаться за секунды
2. **Средние файлы** (10-100MB): Должны загружаться со скоростью > 1MB/s  
3. **Большие файлы** (> 100MB): Должны загружаться стабильно без таймаутов

## Мониторинг

### Ключевые метрики для отслеживания:
- **Время загрузки файлов**: Должно быть пропорционально размеру файла
- **Скорость передачи данных**: Не менее 1MB/s для стабильного соединения  
- **Количество ошибок таймаута**: Должно стремиться к нулю
- **Использование памяти PHP процессов**: Контролировать рост памяти

### Целевые показатели производительности:
- **Файлы до 10MB**: Загрузка за 5-15 секунд
- **Файлы 10-50MB**: Скорость не менее 2MB/s
- **Файлы 50-200MB**: Скорость не менее 1.5MB/s  
- **Файлы более 200MB**: Стабильная загрузка без таймаутов

### Команды для мониторинга:
```bash
# Отслеживание статистики загрузки (Windows PowerShell)
Get-Content storage\logs\laravel.log -Wait | Select-String "Статистика загрузки"

# Отслеживание ошибок
Get-Content storage\logs\laravel.log -Wait | Select-String "ERROR|CRITICAL"

# Анализ производительности за последний час
Get-Content storage\logs\laravel.log | Select-String "Статистика загрузки" | Select-Object -Last 20
```

При скорости ниже 1MB/s система будет логировать предупреждения и предпринимать попытки оптимизации соединения.

## Дополнительные рекомендации

### Безопасность
- Регулярно обновляйте токен Yandex Disk
- Используйте HTTPS для всех запросов
- Ограничьте доступ к файлам конфигурации

### Производительность
- Рассмотрите использование CDN для больших файлов
- Внедрите систему очередей для асинхронной обработки
- Используйте мониторинг производительности в реальном времени

### Надежность  
- Реализуйте механизм повторных попыток
- Добавьте проверку целостности файлов
- Создайте систему бэкапов важных данных
