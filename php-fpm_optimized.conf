# Оптимизированные настройки PHP-FPM для загрузки больших файлов
# Добавьте эти настройки в ваш файл www.conf или создайте отдельный pool

[www]
; Настройки процессов
pm = dynamic
pm.max_children = 50
pm.start_servers = 5
pm.min_spare_servers = 5
pm.max_spare_servers = 35
pm.max_requests = 1000

; Таймауты для больших файлов
request_terminate_timeout = 1800s ; 30 минут
request_slowlog_timeout = 300s    ; 5 минут для логирования медленных запросов

; Настройки памяти
php_admin_value[memory_limit] = -1
php_admin_value[max_execution_time] = 0
php_admin_value[max_input_time] = 0

; Настройки загрузки файлов
php_admin_value[upload_max_filesize] = 0
php_admin_value[post_max_size] = 0
php_admin_value[max_file_uploads] = 1000

; Настройки буферизации
php_admin_value[output_buffering] = Off
php_admin_value[zlib.output_compression] = Off

; Настройки сокетов и сети
php_admin_value[default_socket_timeout] = 1800

; Оптимизация для больших данных
php_admin_value[realpath_cache_size] = 16384K
php_admin_value[realpath_cache_ttl] = 1200

; Настройки для работы с большими массивами данных
php_admin_value[max_input_vars] = 50000
php_admin_value[max_input_nesting_level] = 256

; Настройки PCRE для больших данных
php_admin_value[pcre.backtrack_limit] = 1000000000
php_admin_value[pcre.recursion_limit] = 1000000000

; Настройки сессий для больших загрузок
php_admin_value[session.cache_limiter] = nocache
php_admin_value[session.cache_expire] = 0

; Включаем OPcache для производительности
php_admin_value[opcache.enable] = 1
php_admin_value[opcache.memory_consumption] = 256
php_admin_value[opcache.max_accelerated_files] = 10000

; Логирование ошибок
php_admin_value[log_errors] = on
php_admin_value[error_log] = /var/log/php-fpm/www-error.log

; Медленные запросы
slowlog = /var/log/php-fpm/www-slow.log
